<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NES Racing Game</title>
    <style>
        * {
            box-sizing: border-box;
            touch-action: manipulation;
        }

        body {
            margin: 0;
            padding: 10px;
            background: #1a1a2e;
            font-family: 'Segoe UI', Arial, sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #eee;
        }

        h1 {
            color: #e94560;
            margin: 10px 0;
            font-size: 1.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        #game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 600px;
        }

        #nes-canvas {
            width: 100%;
            max-width: 512px;
            aspect-ratio: 256 / 240;
            background: #000;
            border: 4px solid #333;
            border-radius: 8px;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }

        #controls {
            display: flex;
            justify-content: space-between;
            width: 100%;
            max-width: 500px;
            padding: 20px 10px;
            gap: 20px;
        }

        /* D-Pad */
        .dpad-container {
            position: relative;
            width: 130px;
            height: 130px;
        }

        .dpad-btn {
            position: absolute;
            width: 45px;
            height: 45px;
            background: linear-gradient(145deg, #3a3a5a, #2a2a4a);
            border: 2px solid #555;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: #aaa;
            cursor: pointer;
            user-select: none;
            -webkit-user-select: none;
            transition: all 0.1s;
        }

        .dpad-btn:active, .dpad-btn.pressed {
            background: linear-gradient(145deg, #e94560, #c73e54);
            border-color: #ff6b6b;
            color: #fff;
            transform: scale(0.95);
        }

        .dpad-up { top: 0; left: 50%; transform: translateX(-50%); }
        .dpad-down { bottom: 0; left: 50%; transform: translateX(-50%); }
        .dpad-left { left: 0; top: 50%; transform: translateY(-50%); }
        .dpad-right { right: 0; top: 50%; transform: translateY(-50%); }

        .dpad-up:active, .dpad-up.pressed { transform: translateX(-50%) scale(0.95); }
        .dpad-down:active, .dpad-down.pressed { transform: translateX(-50%) scale(0.95); }
        .dpad-left:active, .dpad-left.pressed { transform: translateY(-50%) scale(0.95); }
        .dpad-right:active, .dpad-right.pressed { transform: translateY(-50%) scale(0.95); }

        /* Action buttons */
        .action-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
        }

        .action-row {
            display: flex;
            gap: 15px;
        }

        .action-btn {
            width: 55px;
            height: 55px;
            border-radius: 50%;
            background: linear-gradient(145deg, #3a3a5a, #2a2a4a);
            border: 3px solid #555;
            color: #aaa;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
            user-select: none;
            -webkit-user-select: none;
            transition: all 0.1s;
        }

        .action-btn:active, .action-btn.pressed {
            background: linear-gradient(145deg, #e94560, #c73e54);
            border-color: #ff6b6b;
            color: #fff;
            transform: scale(0.95);
        }

        .start-select-row {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }

        .small-btn {
            width: 60px;
            height: 30px;
            border-radius: 15px;
            background: linear-gradient(145deg, #3a3a5a, #2a2a4a);
            border: 2px solid #555;
            color: #aaa;
            font-size: 11px;
            cursor: pointer;
            user-select: none;
            -webkit-user-select: none;
        }

        .small-btn:active, .small-btn.pressed {
            background: linear-gradient(145deg, #e94560, #c73e54);
            border-color: #ff6b6b;
            color: #fff;
        }

        #status {
            margin-top: 10px;
            padding: 10px;
            background: #2a2a4a;
            border-radius: 5px;
            font-size: 14px;
            text-align: center;
        }

        .loading {
            color: #ffd93d;
        }

        .ready {
            color: #6bcb77;
        }

        .error {
            color: #ff6b6b;
        }

        /* Desktop keyboard hint */
        #keyboard-hint {
            margin-top: 15px;
            padding: 10px;
            background: #2a2a4a;
            border-radius: 5px;
            font-size: 12px;
            text-align: center;
            color: #888;
        }

        @media (min-width: 768px) {
            #controls {
                opacity: 0.3;
            }
            #controls:hover {
                opacity: 1;
            }
        }

        @media (max-width: 400px) {
            .dpad-container {
                width: 110px;
                height: 110px;
            }
            .dpad-btn {
                width: 38px;
                height: 38px;
                font-size: 16px;
            }
            .action-btn {
                width: 48px;
                height: 48px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <h1>NES Racing Game</h1>

    <div id="game-container">
        <canvas id="nes-canvas" width="256" height="240"></canvas>

        <div id="controls">
            <!-- D-Pad -->
            <div class="dpad-container">
                <button class="dpad-btn dpad-up" data-key="up">&#9650;</button>
                <button class="dpad-btn dpad-down" data-key="down">&#9660;</button>
                <button class="dpad-btn dpad-left" data-key="left">&#9664;</button>
                <button class="dpad-btn dpad-right" data-key="right">&#9654;</button>
            </div>

            <!-- Action buttons -->
            <div class="action-container">
                <div class="action-row">
                    <button class="action-btn" data-key="b">B</button>
                    <button class="action-btn" data-key="a">A</button>
                </div>
                <div class="start-select-row">
                    <button class="small-btn" data-key="select">SELECT</button>
                    <button class="small-btn" data-key="start">START</button>
                </div>
            </div>
        </div>

        <div id="status" class="loading">Loading emulator...</div>

        <div id="keyboard-hint">
            Keyboard: Arrow keys = D-Pad, Z = A, X = B, Enter = Start, Shift = Select
        </div>
    </div>

    <script src="https://unpkg.com/jsnes@1.2.1/dist/jsnes.min.js"></script>
    <script>
        // NES Emulator setup
        const canvas = document.getElementById('nes-canvas');
        const ctx = canvas.getContext('2d');
        const status = document.getElementById('status');

        // Create ImageData for rendering
        const imageData = ctx.createImageData(256, 240);

        // Audio context
        let audioCtx = null;
        let scriptNode = null;
        const audioBuffer = [];
        const AUDIO_BUFFER_SIZE = 8192;

        // Create JSNES emulator
        const nes = new jsnes.NES({
            onFrame: function(frameBuffer) {
                // Convert frame buffer to ImageData
                for (let i = 0; i < frameBuffer.length; i++) {
                    const pixel = frameBuffer[i];
                    const j = i * 4;
                    imageData.data[j] = pixel & 0xFF;           // R
                    imageData.data[j + 1] = (pixel >> 8) & 0xFF;  // G
                    imageData.data[j + 2] = (pixel >> 16) & 0xFF; // B
                    imageData.data[j + 3] = 0xFF;                 // A
                }
                ctx.putImageData(imageData, 0, 0);
            },
            onAudioSample: function(left, right) {
                if (audioBuffer.length < AUDIO_BUFFER_SIZE) {
                    audioBuffer.push(left);
                    audioBuffer.push(right);
                }
            }
        });

        // Initialize audio
        function initAudio() {
            if (audioCtx) return;

            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            scriptNode = audioCtx.createScriptProcessor(1024, 0, 2);
            scriptNode.onaudioprocess = function(e) {
                const left = e.outputBuffer.getChannelData(0);
                const right = e.outputBuffer.getChannelData(1);
                for (let i = 0; i < left.length; i++) {
                    if (audioBuffer.length >= 2) {
                        left[i] = audioBuffer.shift();
                        right[i] = audioBuffer.shift();
                    } else {
                        left[i] = 0;
                        right[i] = 0;
                    }
                }
            };
            scriptNode.connect(audioCtx.destination);
        }

        // Key mapping
        const keyMap = {
            'ArrowUp': jsnes.Controller.BUTTON_UP,
            'ArrowDown': jsnes.Controller.BUTTON_DOWN,
            'ArrowLeft': jsnes.Controller.BUTTON_LEFT,
            'ArrowRight': jsnes.Controller.BUTTON_RIGHT,
            'KeyZ': jsnes.Controller.BUTTON_A,
            'KeyX': jsnes.Controller.BUTTON_B,
            'Enter': jsnes.Controller.BUTTON_START,
            'ShiftRight': jsnes.Controller.BUTTON_SELECT,
            'ShiftLeft': jsnes.Controller.BUTTON_SELECT
        };

        // Touch button mapping
        const buttonMap = {
            'up': jsnes.Controller.BUTTON_UP,
            'down': jsnes.Controller.BUTTON_DOWN,
            'left': jsnes.Controller.BUTTON_LEFT,
            'right': jsnes.Controller.BUTTON_RIGHT,
            'a': jsnes.Controller.BUTTON_A,
            'b': jsnes.Controller.BUTTON_B,
            'start': jsnes.Controller.BUTTON_START,
            'select': jsnes.Controller.BUTTON_SELECT
        };

        // Keyboard events
        document.addEventListener('keydown', (e) => {
            initAudio();
            const button = keyMap[e.code];
            if (button !== undefined) {
                nes.buttonDown(1, button);
                e.preventDefault();
            }
        });

        document.addEventListener('keyup', (e) => {
            const button = keyMap[e.code];
            if (button !== undefined) {
                nes.buttonUp(1, button);
                e.preventDefault();
            }
        });

        // Touch events for virtual pad
        function handleTouchStart(e) {
            e.preventDefault();
            initAudio();
            const btn = e.target.closest('[data-key]');
            if (btn) {
                const key = btn.dataset.key;
                const button = buttonMap[key];
                if (button !== undefined) {
                    nes.buttonDown(1, button);
                    btn.classList.add('pressed');
                }
            }
        }

        function handleTouchEnd(e) {
            e.preventDefault();
            const btn = e.target.closest('[data-key]');
            if (btn) {
                const key = btn.dataset.key;
                const button = buttonMap[key];
                if (button !== undefined) {
                    nes.buttonUp(1, button);
                    btn.classList.remove('pressed');
                }
            }
        }

        // Add touch listeners to all buttons
        document.querySelectorAll('[data-key]').forEach(btn => {
            btn.addEventListener('touchstart', handleTouchStart, { passive: false });
            btn.addEventListener('touchend', handleTouchEnd, { passive: false });
            btn.addEventListener('touchcancel', handleTouchEnd, { passive: false });

            // Mouse support for testing on desktop
            btn.addEventListener('mousedown', (e) => {
                initAudio();
                const key = btn.dataset.key;
                const button = buttonMap[key];
                if (button !== undefined) {
                    nes.buttonDown(1, button);
                    btn.classList.add('pressed');
                }
            });
            btn.addEventListener('mouseup', (e) => {
                const key = btn.dataset.key;
                const button = buttonMap[key];
                if (button !== undefined) {
                    nes.buttonUp(1, button);
                    btn.classList.remove('pressed');
                }
            });
            btn.addEventListener('mouseleave', (e) => {
                const key = btn.dataset.key;
                const button = buttonMap[key];
                if (button !== undefined) {
                    nes.buttonUp(1, button);
                    btn.classList.remove('pressed');
                }
            });
        });

        // Load ROM
        async function loadROM() {
            try {
                status.textContent = 'Loading ROM...';
                status.className = 'loading';

                const response = await fetch('/race.nes');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const arrayBuffer = await response.arrayBuffer();
                const romData = new Uint8Array(arrayBuffer);

                // Convert to string for JSNES
                let romString = '';
                for (let i = 0; i < romData.length; i++) {
                    romString += String.fromCharCode(romData[i]);
                }

                nes.loadROM(romString);

                status.textContent = 'Ready! Press START to play';
                status.className = 'ready';

                // Start emulation loop
                function frame() {
                    nes.frame();
                    requestAnimationFrame(frame);
                }
                frame();

            } catch (err) {
                status.textContent = 'Error loading ROM: ' + err.message;
                status.className = 'error';
                console.error('ROM load error:', err);
            }
        }

        // Start loading
        loadROM();
    </script>
</body>
</html>
