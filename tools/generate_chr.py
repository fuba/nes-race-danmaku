#!/usr/bin/env python3
"""
Generate CHR-ROM data for NES Racing Game
Each tile is 8x8 pixels, 2 bits per pixel (4 colors)
Format: 8 bytes low bits + 8 bytes high bits = 16 bytes per tile
"""

import sys

def encode_tile(pixels):
    """
    Encode 8x8 pixel tile into NES CHR format.
    pixels is a list of 8 strings, each 8 characters.
    Characters: '0'=transparent, '1'=color1, '2'=color2, '3'=color3
    """
    low_plane = []
    high_plane = []

    for row in pixels:
        low_byte = 0
        high_byte = 0
        for i, c in enumerate(row[:8]):
            color = int(c) if c.isdigit() else 0
            if color & 1:
                low_byte |= (0x80 >> i)
            if color & 2:
                high_byte |= (0x80 >> i)
        low_plane.append(low_byte)
        high_plane.append(high_byte)

    return bytes(low_plane + high_plane)


# Define tiles

# Tile 0x00: Empty
TILE_EMPTY = [
    "00000000",
    "00000000",
    "00000000",
    "00000000",
    "00000000",
    "00000000",
    "00000000",
    "00000000",
]

# Tile 0x01: Road
TILE_ROAD = [
    "11111111",
    "11111111",
    "11111111",
    "11111111",
    "11111111",
    "11111111",
    "11111111",
    "11111111",
]

# Tile 0x02: Grass
TILE_GRASS = [
    "11211121",
    "21112111",
    "11121112",
    "12111211",
    "11211121",
    "21112111",
    "11121112",
    "12111211",
]

# Tile 0x03: Center line (dashed)
TILE_LINE = [
    "11131111",
    "11131111",
    "11131111",
    "11111111",
    "11111111",
    "11131111",
    "11131111",
    "11131111",
]

# Tile 0x04: Obstacle (oil slick / debris)
TILE_OBSTACLE = [
    "00111100",
    "01222210",
    "12222221",
    "12233221",
    "12233221",
    "12222221",
    "01222210",
    "00111100",
]

# Tile 0x05: Slash "/" for display
TILE_SLASH = [
    "00000011",
    "00000110",
    "00001100",
    "00011000",
    "00110000",
    "01100000",
    "11000000",
    "00000000",
]

# Tile 0x06: Progress bar filled segment
TILE_BAR_FILL = [
    "11111111",
    "33333333",
    "33333333",
    "33333333",
    "33333333",
    "33333333",
    "33333333",
    "11111111",
]

# Tile 0x07: Progress bar empty segment
TILE_BAR_EMPTY = [
    "11111111",
    "10000001",
    "10000001",
    "10000001",
    "10000001",
    "10000001",
    "10000001",
    "11111111",
]

# Tile 0x08: Small car icon for progress
TILE_CAR_ICON = [
    "00111100",
    "01111110",
    "11111111",
    "11011011",
    "11111111",
    "01111110",
    "00111100",
]

# Tile 0x09: Horizontal line (1 pixel, for goal line)
TILE_HLINE = [
    "11111111",
    "00000000",
    "00000000",
    "00000000",
    "00000000",
    "00000000",
    "00000000",
    "00000000",
]

# Tiles 0x10-0x19: Digits 0-9
DIGITS = [
    # 0
    ["00111100",
     "01100110",
     "11000011",
     "11000011",
     "11000011",
     "11000011",
     "01100110",
     "00111100"],
    # 1
    ["00011000",
     "00111000",
     "00011000",
     "00011000",
     "00011000",
     "00011000",
     "00011000",
     "01111110"],
    # 2
    ["00111100",
     "01100110",
     "00000110",
     "00001100",
     "00110000",
     "01100000",
     "11000000",
     "11111110"],
    # 3
    ["00111100",
     "01100110",
     "00000110",
     "00011100",
     "00000110",
     "00000110",
     "01100110",
     "00111100"],
    # 4
    ["00001100",
     "00011100",
     "00101100",
     "01001100",
     "11111110",
     "00001100",
     "00001100",
     "00001100"],
    # 5
    ["11111110",
     "11000000",
     "11111100",
     "00000110",
     "00000110",
     "00000110",
     "11000110",
     "01111100"],
    # 6
    ["00111100",
     "01100000",
     "11000000",
     "11111100",
     "11000110",
     "11000110",
     "01100110",
     "00111100"],
    # 7
    ["11111110",
     "00000110",
     "00001100",
     "00011000",
     "00110000",
     "00110000",
     "00110000",
     "00110000"],
    # 8
    ["00111100",
     "01100110",
     "01100110",
     "00111100",
     "01100110",
     "11000011",
     "11000011",
     "01111110"],
    # 9
    ["00111100",
     "01100110",
     "11000011",
     "01100011",
     "00111110",
     "00000110",
     "00001100",
     "00111000"],
]

# Tiles 0x20-0x39: Letters A-Z
LETTERS = [
    # A
    ["00011000",
     "00111100",
     "01100110",
     "11000011",
     "11111111",
     "11000011",
     "11000011",
     "11000011"],
    # B
    ["11111100",
     "11000110",
     "11000110",
     "11111100",
     "11000110",
     "11000110",
     "11000110",
     "11111100"],
    # C
    ["00111110",
     "01100000",
     "11000000",
     "11000000",
     "11000000",
     "11000000",
     "01100000",
     "00111110"],
    # D
    ["11111100",
     "11000110",
     "11000011",
     "11000011",
     "11000011",
     "11000011",
     "11000110",
     "11111100"],
    # E
    ["11111110",
     "11000000",
     "11000000",
     "11111100",
     "11000000",
     "11000000",
     "11000000",
     "11111110"],
    # F
    ["11111110",
     "11000000",
     "11000000",
     "11111100",
     "11000000",
     "11000000",
     "11000000",
     "11000000"],
    # G
    ["00111110",
     "01100000",
     "11000000",
     "11000000",
     "11001110",
     "11000110",
     "01100110",
     "00111110"],
    # H
    ["11000011",
     "11000011",
     "11000011",
     "11111111",
     "11000011",
     "11000011",
     "11000011",
     "11000011"],
    # I
    ["01111110",
     "00011000",
     "00011000",
     "00011000",
     "00011000",
     "00011000",
     "00011000",
     "01111110"],
    # J
    ["00001110",
     "00000110",
     "00000110",
     "00000110",
     "00000110",
     "11000110",
     "11000110",
     "01111100"],
    # K
    ["11000110",
     "11001100",
     "11011000",
     "11110000",
     "11011000",
     "11001100",
     "11000110",
     "11000011"],
    # L
    ["11000000",
     "11000000",
     "11000000",
     "11000000",
     "11000000",
     "11000000",
     "11000000",
     "11111110"],
    # M
    ["11000011",
     "11100111",
     "11111111",
     "11011011",
     "11000011",
     "11000011",
     "11000011",
     "11000011"],
    # N
    ["11000011",
     "11100011",
     "11110011",
     "11011011",
     "11001111",
     "11000111",
     "11000011",
     "11000011"],
    # O
    ["00111100",
     "01100110",
     "11000011",
     "11000011",
     "11000011",
     "11000011",
     "01100110",
     "00111100"],
    # P
    ["11111100",
     "11000110",
     "11000110",
     "11111100",
     "11000000",
     "11000000",
     "11000000",
     "11000000"],
    # Q
    ["00111100",
     "01100110",
     "11000011",
     "11000011",
     "11000011",
     "11001011",
     "01100110",
     "00111101"],
    # R
    ["11111100",
     "11000110",
     "11000110",
     "11111100",
     "11011000",
     "11001100",
     "11000110",
     "11000011"],
    # S
    ["00111110",
     "01100000",
     "11000000",
     "01111100",
     "00000110",
     "00000011",
     "00000110",
     "01111100"],
    # T
    ["11111111",
     "00011000",
     "00011000",
     "00011000",
     "00011000",
     "00011000",
     "00011000",
     "00011000"],
    # U
    ["11000011",
     "11000011",
     "11000011",
     "11000011",
     "11000011",
     "11000011",
     "01100110",
     "00111100"],
    # V
    ["11000011",
     "11000011",
     "11000011",
     "11000011",
     "01100110",
     "00111100",
     "00011000",
     "00011000"],
    # W
    ["11000011",
     "11000011",
     "11000011",
     "11000011",
     "11011011",
     "11111111",
     "11100111",
     "11000011"],
    # X
    ["11000011",
     "01100110",
     "00111100",
     "00011000",
     "00111100",
     "01100110",
     "11000011",
     "11000011"],
    # Y
    ["11000011",
     "01100110",
     "00111100",
     "00011000",
     "00011000",
     "00011000",
     "00011000",
     "00011000"],
    # Z
    ["11111111",
     "00000110",
     "00001100",
     "00011000",
     "00110000",
     "01100000",
     "11000000",
     "11111111"],
]

# Sprite tiles (for pattern table 1, starting at offset 0x1000 in CHR)

# Player car (4 tiles for 16x16 sprite)
# Top-left
PLAYER_CAR_TL = [
    "00011000",
    "00111100",
    "00111100",
    "01111110",
    "01111110",
    "11111111",
    "11111111",
    "11311311",
]

# Top-right
PLAYER_CAR_TR = [
    "00011000",
    "00111100",
    "00111100",
    "01111110",
    "01111110",
    "11111111",
    "11111111",
    "11311311",
]

# Bottom-left
PLAYER_CAR_BL = [
    "11333311",
    "11111111",
    "11111111",
    "01111110",
    "01111110",
    "00111100",
    "00111100",
    "00022000",
]

# Bottom-right
PLAYER_CAR_BR = [
    "11333311",
    "11111111",
    "11111111",
    "01111110",
    "01111110",
    "00111100",
    "00111100",
    "00022000",
]

# Enemy car (4 tiles for 16x16 sprite)
ENEMY_CAR_TL = [
    "00011000",
    "00222200",
    "00222200",
    "02222220",
    "02222220",
    "22222222",
    "22222222",
    "22122122",
]

ENEMY_CAR_TR = [
    "00011000",
    "00222200",
    "00222200",
    "02222220",
    "02222220",
    "22222222",
    "22222222",
    "22122122",
]

ENEMY_CAR_BL = [
    "22111122",
    "22222222",
    "22222222",
    "02222220",
    "02222220",
    "00222200",
    "00222200",
    "00033000",
]

ENEMY_CAR_BR = [
    "22111122",
    "22222222",
    "22222222",
    "02222220",
    "02222220",
    "00222200",
    "00222200",
    "00033000",
]

# Explosion sprite
EXPLOSION = [
    "00100100",
    "01011010",
    "10111101",
    "01333310",
    "01333310",
    "10111101",
    "01011010",
    "00100100",
]

# Road edge marker (thick vertical stripe with dashes)
ROAD_EDGE = [
    "33333300",
    "33333300",
    "00000000",
    "33333300",
    "33333300",
    "00000000",
    "33333300",
    "33333300",
]

# Arrow sprite (pointing up)
ARROW_UP = [
    "00010000",
    "00111000",
    "01111100",
    "11111110",
    "00010000",
    "00010000",
    "00010000",
    "00000000",
]

# Bullet sprite (small diamond shape - danmaku style)
BULLET = [
    "00011000",
    "00111100",
    "01111110",
    "11111111",
    "11111111",
    "01111110",
    "00111100",
    "00011000",
]

# Bullet sprite 2 (small circle)
BULLET2 = [
    "00111100",
    "01111110",
    "11111111",
    "11111111",
    "11111111",
    "11111111",
    "01111110",
    "00111100",
]

# Bullet sprite 3 (star shape)
BULLET3 = [
    "00011000",
    "00011000",
    "11111111",
    "01111110",
    "00111100",
    "01100110",
    "11000011",
    "00000000",
]

# Water puddle obstacle (4x4 = 16 tiles, 32x32 pixels)
# Organic wavy shape, single color (will use blue palette)
# Row 0 (top row)
PUDDLE_00 = [
    "00000000",
    "00000000",
    "00000000",
    "00000000",
    "00000011",
    "00001111",
    "00011111",
    "00111111",
]

PUDDLE_01 = [
    "00000000",
    "00000000",
    "00011100",
    "00111110",
    "11111111",
    "11111111",
    "11111111",
    "11111111",
]

PUDDLE_02 = [
    "00000000",
    "00000000",
    "00111000",
    "01111100",
    "11111111",
    "11111111",
    "11111111",
    "11111111",
]

PUDDLE_03 = [
    "00000000",
    "00000000",
    "00000000",
    "00000000",
    "11000000",
    "11110000",
    "11111000",
    "11111100",
]

# Row 1
PUDDLE_10 = [
    "00111111",
    "01111111",
    "01111111",
    "11111111",
    "11111111",
    "11111111",
    "11111111",
    "11111111",
]

PUDDLE_11 = [
    "11111111",
    "11111111",
    "11111111",
    "11111111",
    "11111111",
    "11111111",
    "11111111",
    "11111111",
]

PUDDLE_12 = [
    "11111111",
    "11111111",
    "11111111",
    "11111111",
    "11111111",
    "11111111",
    "11111111",
    "11111111",
]

PUDDLE_13 = [
    "11111100",
    "11111110",
    "11111110",
    "11111111",
    "11111111",
    "11111111",
    "11111111",
    "11111111",
]

# Row 2
PUDDLE_20 = [
    "11111111",
    "11111111",
    "11111111",
    "11111111",
    "11111111",
    "01111111",
    "01111111",
    "00111111",
]

PUDDLE_21 = [
    "11111111",
    "11111111",
    "11111111",
    "11111111",
    "11111111",
    "11111111",
    "11111111",
    "11111111",
]

PUDDLE_22 = [
    "11111111",
    "11111111",
    "11111111",
    "11111111",
    "11111111",
    "11111111",
    "11111111",
    "11111111",
]

PUDDLE_23 = [
    "11111111",
    "11111111",
    "11111111",
    "11111111",
    "11111111",
    "11111110",
    "11111110",
    "11111100",
]

# Row 3 (bottom row)
PUDDLE_30 = [
    "00111111",
    "00011111",
    "00011111",
    "00001111",
    "00000111",
    "00000011",
    "00000000",
    "00000000",
]

PUDDLE_31 = [
    "11111111",
    "11111111",
    "11111111",
    "11111110",
    "01111100",
    "00111000",
    "00000000",
    "00000000",
]

PUDDLE_32 = [
    "11111111",
    "11111111",
    "11111111",
    "01111111",
    "00111110",
    "00011100",
    "00000000",
    "00000000",
]

PUDDLE_33 = [
    "11111100",
    "11111000",
    "11111000",
    "11110000",
    "11100000",
    "11000000",
    "00000000",
    "00000000",
]


def main():
    if len(sys.argv) < 2:
        print("Usage: generate_chr.py <output.chr>")
        sys.exit(1)

    output_file = sys.argv[1]

    # Build CHR-ROM (8KB = 8192 bytes)
    # Pattern table 0: 256 tiles for backgrounds ($0000-$0FFF)
    # Pattern table 1: 256 tiles for sprites ($1000-$1FFF)

    chr_data = bytearray(8192)

    # Pattern table 0 (backgrounds)
    tiles_bg = [
        (0x00, TILE_EMPTY),
        (0x01, TILE_ROAD),
        (0x02, TILE_GRASS),
        (0x03, TILE_LINE),
        (0x04, TILE_OBSTACLE),
        (0x05, TILE_SLASH),
        (0x06, TILE_BAR_FILL),
        (0x07, TILE_BAR_EMPTY),
        (0x08, TILE_CAR_ICON),
        (0x09, TILE_HLINE),
    ]

    # Add digits
    for i, digit in enumerate(DIGITS):
        tiles_bg.append((0x10 + i, digit))

    # Add letters
    for i, letter in enumerate(LETTERS):
        tiles_bg.append((0x20 + i, letter))

    # Write background tiles
    for tile_idx, tile_data in tiles_bg:
        offset = tile_idx * 16
        encoded = encode_tile(tile_data)
        chr_data[offset:offset + 16] = encoded

    # Pattern table 1 (sprites) - starts at 0x1000
    sprites = [
        (0x00, PLAYER_CAR_TL),
        (0x01, PLAYER_CAR_TR),
        (0x02, PLAYER_CAR_BL),
        (0x03, PLAYER_CAR_BR),
        (0x04, ENEMY_CAR_TL),
        (0x05, ENEMY_CAR_TR),
        (0x06, ENEMY_CAR_BL),
        (0x07, ENEMY_CAR_BR),
        (0x08, TILE_CAR_ICON),   # Car icon for progress bar
        (0x09, TILE_HLINE),      # Horizontal line for goal
        (0x0A, ARROW_UP),
        (0x0B, BULLET),
        (0x0C, BULLET2),
        (0x0D, BULLET3),
        (0x0E, EXPLOSION),       # Explosion effect
        # Water puddle obstacle 4x4 = 16 tiles (0x50-0x5F)
        (0x50, PUDDLE_00), (0x51, PUDDLE_01), (0x52, PUDDLE_02), (0x53, PUDDLE_03),
        (0x54, PUDDLE_10), (0x55, PUDDLE_11), (0x56, PUDDLE_12), (0x57, PUDDLE_13),
        (0x58, PUDDLE_20), (0x59, PUDDLE_21), (0x5A, PUDDLE_22), (0x5B, PUDDLE_23),
        (0x5C, PUDDLE_30), (0x5D, PUDDLE_31), (0x5E, PUDDLE_32), (0x5F, PUDDLE_33),
    ]

    # Also copy some tiles to sprite pattern table for HUD
    for i, digit in enumerate(DIGITS):
        sprites.append((0x10 + i, digit))
    for i, letter in enumerate(LETTERS):
        sprites.append((0x30 + i, letter))  # Changed to 0x30 for SPR_LETTER

    # Note: LAP display simplified to "LX" format, slash not needed

    # Write sprite tiles
    for tile_idx, tile_data in sprites:
        offset = 0x1000 + (tile_idx * 16)
        encoded = encode_tile(tile_data)
        chr_data[offset:offset + 16] = encoded

    # Write output file
    with open(output_file, 'wb') as f:
        f.write(chr_data)

    print(f"Generated {output_file} ({len(chr_data)} bytes)")


if __name__ == "__main__":
    main()
