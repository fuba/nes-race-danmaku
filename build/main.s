;
; File generated by cc65 v 2.18 - Ubuntu 2.19-1
;
	.fopt		compiler,"cc65 v 2.18 - Ubuntu 2.19-1"
	.setcpu		"6502"
	.smart		on
	.autoimport	on
	.case		on
	.debuginfo	off
	.importzp	sp, sreg, regsave, regbank
	.importzp	tmp1, tmp2, tmp3, tmp4, ptr1, ptr2, ptr3, ptr4
	.macpack	longbranch
	.forceimport	__STARTUP__
	.export		_palette
	.export		_main

.segment	"RODATA"

_note_table:
	.word	$06B0
	.word	$0650
	.word	$05F3
	.word	$059D
	.word	$054D
	.word	$0501
	.word	$04B9
	.word	$0475
	.word	$0435
	.word	$03F8
	.word	$03BF
	.word	$0388
	.word	$0358
	.word	$0328
	.word	$02FA
	.word	$02CF
	.word	$02A7
	.word	$0281
	.word	$025C
	.word	$023B
	.word	$021B
	.word	$01FC
	.word	$01DF
	.word	$01C4
	.word	$01AC
	.word	$0194
	.word	$017D
	.word	$0168
	.word	$0153
	.word	$0140
	.word	$012E
	.word	$011D
	.word	$010D
	.word	$00FE
	.word	$00EF
	.word	$00E2
	.word	$00D6
	.word	$00CA
	.word	$00BE
	.word	$00B4
	.word	$00AA
	.word	$00A0
	.word	$0097
	.word	$008F
	.word	$0087
	.word	$007F
	.word	$0078
	.word	$0071
_racing_tri:
	.byte	$04
	.byte	$04
	.byte	$10
	.byte	$04
	.byte	$07
	.byte	$07
	.byte	$13
	.byte	$07
	.byte	$09
	.byte	$09
	.byte	$15
	.byte	$09
	.byte	$07
	.byte	$07
	.byte	$13
	.byte	$07
	.byte	$04
	.byte	$04
	.byte	$10
	.byte	$04
	.byte	$07
	.byte	$07
	.byte	$13
	.byte	$07
	.byte	$09
	.byte	$09
	.byte	$0B
	.byte	$0B
	.byte	$0C
	.byte	$0C
	.byte	$0B
	.byte	$09
_racing_pl1:
	.byte	$1C
	.byte	$FF
	.byte	$1F
	.byte	$1C
	.byte	$FF
	.byte	$23
	.byte	$21
	.byte	$1F
	.byte	$21
	.byte	$FF
	.byte	$24
	.byte	$21
	.byte	$FF
	.byte	$1F
	.byte	$1C
	.byte	$1A
	.byte	$1C
	.byte	$FF
	.byte	$1F
	.byte	$1C
	.byte	$FF
	.byte	$23
	.byte	$21
	.byte	$1F
	.byte	$21
	.byte	$21
	.byte	$23
	.byte	$23
	.byte	$24
	.byte	$24
	.byte	$23
	.byte	$21
_racing_pl2:
	.byte	$17
	.byte	$17
	.byte	$1C
	.byte	$17
	.byte	$1A
	.byte	$1A
	.byte	$1F
	.byte	$1A
	.byte	$1C
	.byte	$1C
	.byte	$21
	.byte	$1C
	.byte	$1A
	.byte	$1A
	.byte	$1F
	.byte	$1A
	.byte	$17
	.byte	$17
	.byte	$1C
	.byte	$17
	.byte	$1A
	.byte	$1A
	.byte	$1F
	.byte	$1A
	.byte	$1C
	.byte	$1C
	.byte	$1E
	.byte	$1E
	.byte	$1F
	.byte	$1F
	.byte	$1E
	.byte	$1C
_racing_noise:
	.byte	$01
	.byte	$03
	.byte	$00
	.byte	$03
	.byte	$02
	.byte	$03
	.byte	$00
	.byte	$03
	.byte	$01
	.byte	$03
	.byte	$00
	.byte	$03
	.byte	$02
	.byte	$03
	.byte	$00
	.byte	$03
	.byte	$01
	.byte	$03
	.byte	$00
	.byte	$03
	.byte	$02
	.byte	$03
	.byte	$00
	.byte	$03
	.byte	$01
	.byte	$03
	.byte	$02
	.byte	$03
	.byte	$01
	.byte	$02
	.byte	$01
	.byte	$02
_title_tri:
	.byte	$0C
	.byte	$0C
	.byte	$00
	.byte	$0C
	.byte	$07
	.byte	$07
	.byte	$07
	.byte	$13
	.byte	$09
	.byte	$09
	.byte	$09
	.byte	$15
	.byte	$07
	.byte	$07
	.byte	$07
	.byte	$13
	.byte	$05
	.byte	$05
	.byte	$05
	.byte	$11
	.byte	$07
	.byte	$07
	.byte	$07
	.byte	$13
	.byte	$09
	.byte	$09
	.byte	$07
	.byte	$07
	.byte	$0C
	.byte	$0C
	.byte	$0C
	.byte	$0C
_title_pl1:
	.byte	$24
	.byte	$24
	.byte	$1F
	.byte	$24
	.byte	$28
	.byte	$28
	.byte	$26
	.byte	$24
	.byte	$21
	.byte	$21
	.byte	$24
	.byte	$21
	.byte	$1F
	.byte	$1F
	.byte	$1C
	.byte	$1F
	.byte	$1D
	.byte	$1D
	.byte	$21
	.byte	$24
	.byte	$1F
	.byte	$1F
	.byte	$23
	.byte	$26
	.byte	$28
	.byte	$28
	.byte	$26
	.byte	$24
	.byte	$24
	.byte	$FF
	.byte	$24
	.byte	$FF
_title_pl2:
	.byte	$1C
	.byte	$1C
	.byte	$18
	.byte	$1C
	.byte	$1F
	.byte	$1F
	.byte	$1D
	.byte	$1C
	.byte	$18
	.byte	$18
	.byte	$1C
	.byte	$18
	.byte	$1A
	.byte	$1A
	.byte	$18
	.byte	$1A
	.byte	$15
	.byte	$15
	.byte	$18
	.byte	$1C
	.byte	$1A
	.byte	$1A
	.byte	$1D
	.byte	$1F
	.byte	$1F
	.byte	$1F
	.byte	$1D
	.byte	$1C
	.byte	$1C
	.byte	$FF
	.byte	$1C
	.byte	$FF
_win_tri:
	.byte	$0C
	.byte	$0C
	.byte	$07
	.byte	$07
	.byte	$0C
	.byte	$0C
	.byte	$0C
	.byte	$0C
	.byte	$05
	.byte	$05
	.byte	$0C
	.byte	$0C
	.byte	$07
	.byte	$07
	.byte	$0C
	.byte	$0C
_win_pl1:
	.byte	$24
	.byte	$28
	.byte	$2B
	.byte	$2B
	.byte	$28
	.byte	$24
	.byte	$28
	.byte	$2B
	.byte	$29
	.byte	$29
	.byte	$28
	.byte	$28
	.byte	$26
	.byte	$26
	.byte	$24
	.byte	$24
_win_pl2:
	.byte	$1C
	.byte	$1F
	.byte	$24
	.byte	$24
	.byte	$1F
	.byte	$1C
	.byte	$1F
	.byte	$24
	.byte	$21
	.byte	$21
	.byte	$1F
	.byte	$1F
	.byte	$1D
	.byte	$1D
	.byte	$1C
	.byte	$1C
_gameover_tri:
	.byte	$09
	.byte	$FF
	.byte	$04
	.byte	$FF
	.byte	$05
	.byte	$FF
	.byte	$04
	.byte	$FF
	.byte	$02
	.byte	$FF
	.byte	$09
	.byte	$FF
	.byte	$04
	.byte	$FF
	.byte	$04
	.byte	$FF
_gameover_pl1:
	.byte	$1C
	.byte	$1A
	.byte	$18
	.byte	$17
	.byte	$15
	.byte	$FF
	.byte	$14
	.byte	$FF
	.byte	$15
	.byte	$17
	.byte	$18
	.byte	$FF
	.byte	$17
	.byte	$15
	.byte	$FF
	.byte	$FF
_gameover_pl2:
	.byte	$18
	.byte	$17
	.byte	$15
	.byte	$14
	.byte	$11
	.byte	$FF
	.byte	$10
	.byte	$FF
	.byte	$11
	.byte	$14
	.byte	$15
	.byte	$FF
	.byte	$14
	.byte	$10
	.byte	$FF
	.byte	$FF
_palette:
	.byte	$0F
	.byte	$00
	.byte	$10
	.byte	$30
	.byte	$0F
	.byte	$09
	.byte	$19
	.byte	$29
	.byte	$0F
	.byte	$01
	.byte	$21
	.byte	$31
	.byte	$0F
	.byte	$16
	.byte	$27
	.byte	$37
	.byte	$0F
	.byte	$11
	.byte	$21
	.byte	$31
	.byte	$0F
	.byte	$06
	.byte	$16
	.byte	$26
	.byte	$0F
	.byte	$07
	.byte	$17
	.byte	$27
	.byte	$0F
	.byte	$30
	.byte	$30
	.byte	$30
_sin_table:
	.byte	$00
	.byte	$01
	.byte	$02
	.byte	$01
	.byte	$00
	.byte	$FF
	.byte	$FE
	.byte	$FF
_cos_table:
	.byte	$02
	.byte	$01
	.byte	$00
	.byte	$FF
	.byte	$FE
	.byte	$FF
	.byte	$00
	.byte	$01

.segment	"BSS"

_game_state:
	.res	1,$00
_frame_count:
	.res	1,$00
_scroll_y:
	.res	1,$00
_pad_now:
	.res	1,$00
_pad_old:
	.res	1,$00
_pad_new:
	.res	1,$00
_player_x:
	.res	1,$00
_player_y:
	.res	1,$00
_player_hp:
	.res	1,$00
_player_inv:
	.res	1,$00
_enemy_x:
	.res	1,$00
_enemy_y:
	.res	1,$00
_enemy_speed:
	.res	1,$00
_enemy_on:
	.res	1,$00
_enemy_next_x:
	.res	1,$00
_enemy_warn_timer:
	.res	1,$00
_position:
	.res	1,$00
_lap_count:
	.res	1,$00
_score:
	.res	2,$00
_distance:
	.res	2,$00
_obs_x:
	.res	4,$00
_obs_y:
	.res	4,$00
_obs_on:
	.res	4,$00
_bullet_x:
	.res	16,$00
_bullet_y:
	.res	16,$00
_bullet_dx:
	.res	16,$00
_bullet_dy:
	.res	16,$00
_bullet_on:
	.res	16,$00
_bullet_timer:
	.res	1,$00
_pit_timer:
	.res	1,$00
_rnd_seed:
	.res	1,$00
_win_timer:
	.res	1,$00
_confetti_x:
	.res	12,$00
_confetti_y:
	.res	12,$00
_confetti_color:
	.res	12,$00
_music_enabled:
	.res	1,$00
_music_frame:
	.res	1,$00
_music_pos:
	.res	1,$00
_music_tempo:
	.res	1,$00
_current_track:
	.res	1,$00
_tri_note:
	.res	1,$00
_pl1_note:
	.res	1,$00
_pl2_note:
	.res	1,$00
_noise_on:
	.res	1,$00
_pattern_phase:
	.res	1,$00
_pattern_type:
	.res	1,$00

; ---------------------------------------------------------------
; void __near__ init_apu (void)
; ---------------------------------------------------------------

.segment	"CODE"

.proc	_init_apu: near

.segment	"CODE"

;
; APU_STATUS = 0x0F;  // Enable pulse1, pulse2, triangle, noise
;
	lda     #$0F
	sta     $4015
;
; APU_FRAME = 0x40;
;
	lda     #$40
	sta     $4017
;
; APU_PL1_VOL = 0x30;  // Silence, constant volume
;
	lda     #$30
	sta     $4000
;
; APU_PL2_VOL = 0x30;
;
	sta     $4004
;
; APU_TRI_LIN = 0x80;  // Silence triangle
;
	lda     #$80
	sta     $4008
;
; APU_NOI_VOL = 0x30;
;
	lda     #$30
	sta     $400C
;
; music_enabled = 1;
;
	lda     #$01
	sta     _music_enabled
;
; music_frame = 0;
;
	lda     #$00
	sta     _music_frame
;
; music_pos = 0;
;
	sta     _music_pos
;
; music_tempo = 8;  // 8 frames per beat = ~7.5 BPS at 60fps
;
	lda     #$08
	sta     _music_tempo
;
; current_track = 0;
;
	lda     #$00
	sta     _current_track
;
; }
;
	rts

.endproc

; ---------------------------------------------------------------
; void __near__ play_triangle (unsigned char)
; ---------------------------------------------------------------

.segment	"CODE"

.proc	_play_triangle: near

.segment	"CODE"

;
; static void play_triangle(unsigned char note) {
;
	jsr     pusha
;
; if (note == NOTE_REST || note >= 48) {
;
	jsr     decsp2
	ldy     #$02
	lda     (sp),y
	cmp     #$FF
	beq     L0A84
	cmp     #$30
	bcs     L0A84
	ldx     #$00
	jmp     L0A86
;
; APU_TRI_LIN = 0x00;  // Silence
;
L0A84:	lda     #$00
	sta     $4008
;
; return;
;
	jmp     incsp3
;
; period = note_table[note];
;
L0A86:	lda     (sp),y
	asl     a
	bcc     L0A83
	inx
	clc
L0A83:	adc     #<(_note_table)
	sta     ptr1
	txa
	adc     #>(_note_table)
	sta     ptr1+1
	dey
	lda     (ptr1),y
	tax
	dey
	lda     (ptr1),y
	jsr     stax0sp
;
; APU_TRI_LIN = 0xFF;  // Max linear counter (sustain)
;
	lda     #$FF
	sta     $4008
;
; APU_TRI_LO = (unsigned char)(period & 0xFF);
;
	ldy     #$00
	lda     (sp),y
	sta     $400A
;
; APU_TRI_HI = (unsigned char)((period >> 8) & 0x07) | 0xF8;
;
	iny
	lda     (sp),y
	and     #$07
	ora     #$F8
	sta     $400B
;
; }
;
	jmp     incsp3

.endproc

; ---------------------------------------------------------------
; void __near__ play_pulse1 (unsigned char)
; ---------------------------------------------------------------

.segment	"CODE"

.proc	_play_pulse1: near

.segment	"CODE"

;
; static void play_pulse1(unsigned char note) {
;
	jsr     pusha
;
; if (note == NOTE_REST || note >= 48) {
;
	jsr     decsp2
	ldy     #$02
	lda     (sp),y
	cmp     #$FF
	beq     L0A89
	cmp     #$30
	bcs     L0A89
	ldx     #$00
	jmp     L0A8B
;
; APU_PL1_VOL = 0x30;  // Silence
;
L0A89:	lda     #$30
	sta     $4000
;
; return;
;
	jmp     incsp3
;
; period = note_table[note];
;
L0A8B:	lda     (sp),y
	asl     a
	bcc     L0A88
	inx
	clc
L0A88:	adc     #<(_note_table)
	sta     ptr1
	txa
	adc     #>(_note_table)
	sta     ptr1+1
	dey
	lda     (ptr1),y
	tax
	dey
	lda     (ptr1),y
	jsr     stax0sp
;
; APU_PL1_VOL = 0xBF;  // 50% duty, constant volume, max volume
;
	lda     #$BF
	sta     $4000
;
; APU_PL1_SWP = 0x00;  // No sweep
;
	lda     #$00
	sta     $4001
;
; APU_PL1_LO = (unsigned char)(period & 0xFF);
;
	tay
	lda     (sp),y
	sta     $4002
;
; APU_PL1_HI = (unsigned char)((period >> 8) & 0x07) | 0xF8;
;
	iny
	lda     (sp),y
	and     #$07
	ora     #$F8
	sta     $4003
;
; }
;
	jmp     incsp3

.endproc

; ---------------------------------------------------------------
; void __near__ play_pulse2 (unsigned char)
; ---------------------------------------------------------------

.segment	"CODE"

.proc	_play_pulse2: near

.segment	"CODE"

;
; static void play_pulse2(unsigned char note) {
;
	jsr     pusha
;
; if (note == NOTE_REST || note >= 48) {
;
	jsr     decsp2
	ldy     #$02
	lda     (sp),y
	cmp     #$FF
	beq     L0A8E
	cmp     #$30
	bcs     L0A8E
	ldx     #$00
	jmp     L0A90
;
; APU_PL2_VOL = 0x30;  // Silence
;
L0A8E:	lda     #$30
	sta     $4004
;
; return;
;
	jmp     incsp3
;
; period = note_table[note];
;
L0A90:	lda     (sp),y
	asl     a
	bcc     L0A8D
	inx
	clc
L0A8D:	adc     #<(_note_table)
	sta     ptr1
	txa
	adc     #>(_note_table)
	sta     ptr1+1
	dey
	lda     (ptr1),y
	tax
	dey
	lda     (ptr1),y
	jsr     stax0sp
;
; APU_PL2_VOL = 0x7A;  // 25% duty, constant volume, medium volume
;
	lda     #$7A
	sta     $4004
;
; APU_PL2_SWP = 0x00;  // No sweep
;
	lda     #$00
	sta     $4005
;
; APU_PL2_LO = (unsigned char)(period & 0xFF);
;
	tay
	lda     (sp),y
	sta     $4006
;
; APU_PL2_HI = (unsigned char)((period >> 8) & 0x07) | 0xF8;
;
	iny
	lda     (sp),y
	and     #$07
	ora     #$F8
	sta     $4007
;
; }
;
	jmp     incsp3

.endproc

; ---------------------------------------------------------------
; void __near__ play_noise (unsigned char)
; ---------------------------------------------------------------

.segment	"CODE"

.proc	_play_noise: near

.segment	"CODE"

;
; static void play_noise(unsigned char type) {
;
	jsr     pusha
;
; switch (type) {
;
	ldy     #$00
	lda     (sp),y
;
; }
;
	beq     L0A92
	cmp     #$01
	beq     L0A93
	cmp     #$02
	beq     L0A94
	cmp     #$03
	beq     L0A95
	jmp     incsp1
;
; APU_NOI_VOL = 0x30;
;
L0A92:	lda     #$30
	sta     $400C
;
; break;
;
	jmp     incsp1
;
; APU_NOI_VOL = 0x3F;  // Constant, max volume
;
L0A93:	lda     #$3F
	sta     $400C
;
; APU_NOI_LO = 0x0C;   // Low pitch
;
	lda     #$0C
	sta     $400E
;
; APU_NOI_HI = 0x18;
;
	lda     #$18
;
; break;
;
	jmp     L0A91
;
; APU_NOI_VOL = 0x3A;  // Constant, medium volume
;
L0A94:	lda     #$3A
	sta     $400C
;
; APU_NOI_LO = 0x05;   // Mid pitch, mode bit
;
	lda     #$05
	sta     $400E
;
; APU_NOI_HI = 0x28;
;
	lda     #$28
;
; break;
;
	jmp     L0A91
;
; APU_NOI_VOL = 0x34;  // Constant, low volume
;
L0A95:	lda     #$34
	sta     $400C
;
; APU_NOI_LO = 0x02;   // High pitch
;
	lda     #$02
	sta     $400E
;
; APU_NOI_HI = 0x08;
;
	lda     #$08
L0A91:	sta     $400F
;
; }
;
	jmp     incsp1

.endproc

; ---------------------------------------------------------------
; void __near__ music_play (unsigned char)
; ---------------------------------------------------------------

.segment	"CODE"

.proc	_music_play: near

.segment	"CODE"

;
; static void music_play(unsigned char track) {
;
	jsr     pusha
;
; current_track = track;
;
	ldy     #$00
	lda     (sp),y
	sta     _current_track
;
; music_pos = 0;
;
	tya
	sta     _music_pos
;
; music_frame = 0;
;
	sta     _music_frame
;
; switch (track) {
;
	lda     (sp),y
;
; }
;
	beq     L0A97
	cmp     #$01
	beq     L0A98
	cmp     #$02
	beq     L0A99
	cmp     #$03
	beq     L0A9A
	jmp     incsp1
;
; music_tempo = 8;   // Strong, steady tempo
;
L0A97:	lda     #$08
;
; break;
;
	jmp     L0A96
;
; music_tempo = 6;   // Fast!
;
L0A98:	lda     #$06
;
; break;
;
	jmp     L0A96
;
; music_tempo = 10;  // Medium
;
L0A99:	lda     #$0A
;
; break;
;
	jmp     L0A96
;
; music_tempo = 16;  // Very slow, sad
;
L0A9A:	lda     #$10
L0A96:	sta     _music_tempo
;
; }
;
	jmp     incsp1

.endproc

; ---------------------------------------------------------------
; void __near__ music_update (void)
; ---------------------------------------------------------------

.segment	"CODE"

.proc	_music_update: near

.segment	"CODE"

;
; if (!music_enabled) return;
;
	ldy     #$09
	jsr     subysp
	lda     _music_enabled
	jeq     L02AC
;
; ++music_frame;
;
	inc     _music_frame
;
; if (music_frame < music_tempo) return;
;
	lda     _music_frame
	cmp     _music_tempo
	jcc     L02AC
;
; music_frame = 0;
;
	lda     #$00
	sta     _music_frame
;
; switch (current_track) {
;
	lda     _current_track
;
; }
;
	beq     L0A9F
	cmp     #$01
	beq     L0AA0
	cmp     #$02
	beq     L0AA1
	cmp     #$03
	beq     L0AA2
	jmp     L02AC
;
; len = TITLE_LEN;
;
L0A9F:	lda     #$20
	ldy     #$08
	sta     (sp),y
;
; tri_data = title_tri;
;
	lda     #<(_title_tri)
	ldx     #>(_title_tri)
	ldy     #$06
	jsr     staxysp
;
; pl1_data = title_pl1;
;
	lda     #<(_title_pl1)
	ldx     #>(_title_pl1)
	ldy     #$04
	jsr     staxysp
;
; pl2_data = title_pl2;
;
	lda     #<(_title_pl2)
	ldx     #>(_title_pl2)
;
; break;
;
	jmp     L0AA9
;
; len = RACING_LEN;
;
L0AA0:	lda     #$20
	ldy     #$08
	sta     (sp),y
;
; tri_data = racing_tri;
;
	lda     #<(_racing_tri)
	ldx     #>(_racing_tri)
	ldy     #$06
	jsr     staxysp
;
; pl1_data = racing_pl1;
;
	lda     #<(_racing_pl1)
	ldx     #>(_racing_pl1)
	ldy     #$04
	jsr     staxysp
;
; pl2_data = racing_pl2;
;
	lda     #<(_racing_pl2)
	ldx     #>(_racing_pl2)
	ldy     #$02
	jsr     staxysp
;
; noise_data = racing_noise;
;
	lda     #<(_racing_noise)
	ldx     #>(_racing_noise)
	jsr     stax0sp
;
; break;
;
	jmp     L026B
;
; len = WIN_LEN;
;
L0AA1:	lda     #$10
	ldy     #$08
	sta     (sp),y
;
; tri_data = win_tri;
;
	lda     #<(_win_tri)
	ldx     #>(_win_tri)
	ldy     #$06
	jsr     staxysp
;
; pl1_data = win_pl1;
;
	lda     #<(_win_pl1)
	ldx     #>(_win_pl1)
	ldy     #$04
	jsr     staxysp
;
; pl2_data = win_pl2;
;
	lda     #<(_win_pl2)
	ldx     #>(_win_pl2)
;
; break;
;
	jmp     L0AA9
;
; len = GAMEOVER_LEN;
;
L0AA2:	lda     #$10
	ldy     #$08
	sta     (sp),y
;
; tri_data = gameover_tri;
;
	lda     #<(_gameover_tri)
	ldx     #>(_gameover_tri)
	ldy     #$06
	jsr     staxysp
;
; pl1_data = gameover_pl1;
;
	lda     #<(_gameover_pl1)
	ldx     #>(_gameover_pl1)
	ldy     #$04
	jsr     staxysp
;
; pl2_data = gameover_pl2;
;
	lda     #<(_gameover_pl2)
	ldx     #>(_gameover_pl2)
L0AA9:	ldy     #$02
	jsr     staxysp
;
; noise_data = 0;
;
	ldy     #$00
	tya
	sta     (sp),y
	iny
	sta     (sp),y
;
; play_triangle(tri_data[music_pos]);
;
L026B:	ldy     #$07
	lda     (sp),y
	tax
	dey
	lda     (sp),y
	ldy     _music_pos
	sta     ptr1
	stx     ptr1+1
	lda     (ptr1),y
	jsr     _play_triangle
;
; play_pulse1(pl1_data[music_pos]);
;
	ldy     #$05
	lda     (sp),y
	tax
	dey
	lda     (sp),y
	ldy     _music_pos
	sta     ptr1
	stx     ptr1+1
	lda     (ptr1),y
	jsr     _play_pulse1
;
; play_pulse2(pl2_data[music_pos]);
;
	ldy     #$03
	lda     (sp),y
	tax
	dey
	lda     (sp),y
	ldy     _music_pos
	sta     ptr1
	stx     ptr1+1
	lda     (ptr1),y
	jsr     _play_pulse2
;
; if (noise_data) {
;
	ldy     #$01
	lda     (sp),y
	dey
	ora     (sp),y
	beq     L02A6
;
; play_noise(noise_data[music_pos]);
;
	iny
	lda     (sp),y
	tax
	dey
	lda     (sp),y
	ldy     _music_pos
	sta     ptr1
	stx     ptr1+1
	lda     (ptr1),y
	jsr     _play_noise
;
; ++music_pos;
;
L02A6:	inc     _music_pos
;
; if (music_pos >= len) {
;
	lda     _music_pos
	ldy     #$08
	cmp     (sp),y
	bcc     L02AC
;
; music_pos = 0;
;
	lda     #$00
	sta     _music_pos
;
; }
;
L02AC:	ldy     #$09
	jmp     addysp

.endproc

; ---------------------------------------------------------------
; void __near__ wait_vblank (void)
; ---------------------------------------------------------------

.segment	"CODE"

.proc	_wait_vblank: near

.segment	"CODE"

;
; while (!(PPU_STATUS & 0x80));
;
L0AAA:	lda     $2002
	and     #$80
	beq     L0AAA
;
; }
;
	rts

.endproc

; ---------------------------------------------------------------
; void __near__ ppu_off (void)
; ---------------------------------------------------------------

.segment	"CODE"

.proc	_ppu_off: near

.segment	"CODE"

;
; PPU_MASK = 0x00;
;
	lda     #$00
	sta     $2001
;
; }
;
	rts

.endproc

; ---------------------------------------------------------------
; void __near__ ppu_on (void)
; ---------------------------------------------------------------

.segment	"CODE"

.proc	_ppu_on: near

.segment	"CODE"

;
; PPU_MASK = 0x1E;
;
	lda     #$1E
	sta     $2001
;
; }
;
	rts

.endproc

; ---------------------------------------------------------------
; void __near__ ppu_addr (unsigned int)
; ---------------------------------------------------------------

.segment	"CODE"

.proc	_ppu_addr: near

.segment	"CODE"

;
; static void ppu_addr(unsigned int addr) {
;
	jsr     pushax
;
; PPU_ADDR = (unsigned char)(addr >> 8);
;
	ldy     #$01
	lda     (sp),y
	sta     $2006
;
; PPU_ADDR = (unsigned char)(addr);
;
	dey
	lda     (sp),y
	sta     $2006
;
; }
;
	jmp     incsp2

.endproc

; ---------------------------------------------------------------
; unsigned char __near__ read_pad (void)
; ---------------------------------------------------------------

.segment	"CODE"

.proc	_read_pad: near

.segment	"CODE"

;
; unsigned char result = 0;
;
	lda     #$00
	jsr     pusha
;
; JOYPAD1 = 1;
;
	jsr     decsp1
	lda     #$01
	sta     $4016
;
; JOYPAD1 = 0;
;
	lda     #$00
	sta     $4016
;
; for (i = 0; i < 8; ++i) {
;
	tay
L0AAB:	sta     (sp),y
	cmp     #$08
	bcs     L02D1
;
; result <<= 1;
;
	iny
	lda     (sp),y
	asl     a
	sta     (sp),y
;
; result |= (JOYPAD1 & 1);
;
	lda     $4016
	and     #$01
	ora     (sp),y
	sta     (sp),y
;
; for (i = 0; i < 8; ++i) {
;
	dey
	clc
	lda     #$01
	adc     (sp),y
	jmp     L0AAB
;
; return result;
;
L02D1:	iny
	ldx     #$00
	lda     (sp),y
;
; }
;
	jmp     incsp2

.endproc

; ---------------------------------------------------------------
; unsigned char __near__ rnd (void)
; ---------------------------------------------------------------

.segment	"CODE"

.proc	_rnd: near

.segment	"CODE"

;
; rnd_seed ^= (rnd_seed << 5);
;
	ldx     #$00
	lda     _rnd_seed
	jsr     aslax4
	stx     tmp1
	asl     a
	rol     tmp1
	eor     _rnd_seed
	sta     _rnd_seed
;
; rnd_seed ^= (rnd_seed >> 3);
;
	lsr     a
	lsr     a
	lsr     a
	eor     _rnd_seed
	sta     _rnd_seed
;
; rnd_seed ^= (rnd_seed << 7);
;
	asl     a
	asl     a
	asl     a
	asl     a
	asl     a
	asl     a
	asl     a
	eor     _rnd_seed
	sta     _rnd_seed
;
; if (rnd_seed == 0) rnd_seed = 42;
;
	ldx     #$00
	lda     _rnd_seed
	bne     L0AAC
	lda     #$2A
	sta     _rnd_seed
;
; return rnd_seed;
;
L0AAC:	lda     _rnd_seed
;
; }
;
	rts

.endproc

; ---------------------------------------------------------------
; void __near__ init_win_animation (void)
; ---------------------------------------------------------------

.segment	"CODE"

.proc	_init_win_animation: near

.segment	"CODE"

;
; win_timer = 0;
;
	jsr     decsp1
	lda     #$00
	sta     _win_timer
;
; for (i = 0; i < MAX_CONFETTI; ++i) {
;
	tay
L0AAD:	sta     (sp),y
	cmp     #$0C
	bcs     L0829
;
; confetti_x[i] = 32 + (rnd() & 0x7F) + (rnd() & 0x3F);  // Spread across screen
;
	lda     #<(_confetti_x)
	ldx     #>(_confetti_x)
	clc
	adc     (sp),y
	bcc     L0832
	inx
L0832:	jsr     pushax
	jsr     _rnd
	ldx     #$00
	and     #$7F
	clc
	adc     #$20
	bcc     L0835
	inx
L0835:	jsr     pushax
	jsr     _rnd
	and     #$3F
	jsr     tosadda0
	ldy     #$00
	jsr     staspidx
;
; confetti_y[i] = rnd() & 0x1F;  // Start near top
;
	lda     #<(_confetti_y)
	ldx     #>(_confetti_y)
	ldy     #$00
	clc
	adc     (sp),y
	bcc     L0839
	inx
L0839:	jsr     pushax
	jsr     _rnd
	and     #$1F
	ldy     #$00
	jsr     staspidx
;
; confetti_color[i] = rnd() & 0x03;  // Random palette
;
	lda     #<(_confetti_color)
	ldx     #>(_confetti_color)
	ldy     #$00
	clc
	adc     (sp),y
	bcc     L083D
	inx
L083D:	jsr     pushax
	jsr     _rnd
	and     #$03
	ldy     #$00
	jsr     staspidx
;
; for (i = 0; i < MAX_CONFETTI; ++i) {
;
	ldy     #$00
	clc
	lda     #$01
	adc     (sp),y
	jmp     L0AAD
;
; }
;
L0829:	jmp     incsp1

.endproc

; ---------------------------------------------------------------
; void __near__ clear_sprites (void)
; ---------------------------------------------------------------

.segment	"CODE"

.proc	_clear_sprites: near

.segment	"CODE"

;
; for (i = 0; i < 64; ++i) {
;
	jsr     decsp1
	lda     #$00
	tay
L0AAE:	sta     (sp),y
	cmp     #$40
	bcs     L02F0
;
; OAM[i * 4] = 0xFF;
;
	ldx     #$00
	lda     (sp),y
	jsr     shlax2
	inx
	inx
	sta     ptr1
	stx     ptr1+1
	lda     #$FF
	sta     (ptr1),y
;
; for (i = 0; i < 64; ++i) {
;
	clc
	lda     #$01
	adc     (sp),y
	jmp     L0AAE
;
; }
;
L02F0:	jmp     incsp1

.endproc

; ---------------------------------------------------------------
; unsigned char __near__ set_sprite (unsigned char, unsigned char, unsigned char, unsigned char, unsigned char)
; ---------------------------------------------------------------

.segment	"CODE"

.proc	_set_sprite: near

.segment	"CODE"

;
; unsigned char tile, unsigned char attr) {
;
	jsr     pusha
;
; unsigned char idx = id * 4;
;
	ldy     #$04
	lda     (sp),y
	asl     a
	asl     a
	jsr     pusha
;
; OAM[idx] = y;
;
	ldy     #$00
	lda     (sp),y
	tax
	ldy     #$03
	lda     (sp),y
	sta     $0200,x
;
; OAM[idx + 1] = tile;
;
	ldx     #$00
	lda     (sp,x)
	clc
	adc     #$01
	bcc     L0305
	inx
L0305:	inx
	inx
	sta     ptr1
	stx     ptr1+1
	dey
	lda     (sp),y
	ldy     #$00
	sta     (ptr1),y
;
; OAM[idx + 2] = attr;
;
	ldx     #$00
	lda     (sp),y
	clc
	adc     #$02
	bcc     L030A
	inx
L030A:	inx
	inx
	sta     ptr1
	stx     ptr1+1
	iny
	lda     (sp),y
	dey
	sta     (ptr1),y
;
; OAM[idx + 3] = x;
;
	ldx     #$00
	lda     (sp),y
	clc
	adc     #$03
	bcc     L030F
	inx
L030F:	inx
	inx
	sta     ptr1
	stx     ptr1+1
	ldy     #$04
	lda     (sp),y
	ldy     #$00
	sta     (ptr1),y
;
; return id + 1;
;
	ldy     #$05
	lda     (sp),y
	clc
	adc     #$01
	ldx     #$00
;
; }
;
	jmp     incsp6

.endproc

; ---------------------------------------------------------------
; unsigned char __near__ set_car (unsigned char, unsigned char, unsigned char, unsigned char, unsigned char)
; ---------------------------------------------------------------

.segment	"CODE"

.proc	_set_car: near

.segment	"CODE"

;
; unsigned char tile_base, unsigned char attr) {
;
	jsr     pusha
;
; id = set_sprite(id, x,     y,     tile_base,     attr);
;
	jsr     decsp4
	ldy     #$08
	lda     (sp),y
	ldy     #$03
	sta     (sp),y
	ldy     #$07
	lda     (sp),y
	ldy     #$02
	sta     (sp),y
	ldy     #$06
	lda     (sp),y
	ldy     #$01
	sta     (sp),y
	ldy     #$05
	lda     (sp),y
	ldy     #$00
	sta     (sp),y
	ldy     #$04
	lda     (sp),y
	jsr     _set_sprite
	ldy     #$04
	sta     (sp),y
;
; id = set_sprite(id, x + 8, y,     tile_base + 1, attr);
;
	jsr     decsp4
	ldy     #$08
	lda     (sp),y
	ldy     #$03
	sta     (sp),y
	ldy     #$07
	lda     (sp),y
	clc
	adc     #$08
	ldy     #$02
	sta     (sp),y
	ldy     #$06
	lda     (sp),y
	ldy     #$01
	sta     (sp),y
	ldy     #$05
	lda     (sp),y
	clc
	adc     #$01
	ldy     #$00
	sta     (sp),y
	ldy     #$04
	lda     (sp),y
	jsr     _set_sprite
	ldy     #$04
	sta     (sp),y
;
; id = set_sprite(id, x,     y + 8, tile_base + 2, attr);
;
	jsr     decsp4
	ldy     #$08
	lda     (sp),y
	ldy     #$03
	sta     (sp),y
	ldy     #$07
	lda     (sp),y
	ldy     #$02
	sta     (sp),y
	ldy     #$06
	lda     (sp),y
	clc
	adc     #$08
	ldy     #$01
	sta     (sp),y
	ldy     #$05
	lda     (sp),y
	clc
	adc     #$02
	ldy     #$00
	sta     (sp),y
	ldy     #$04
	lda     (sp),y
	jsr     _set_sprite
	ldy     #$04
	sta     (sp),y
;
; id = set_sprite(id, x + 8, y + 8, tile_base + 3, attr);
;
	jsr     decsp4
	ldy     #$08
	lda     (sp),y
	ldy     #$03
	sta     (sp),y
	ldy     #$07
	lda     (sp),y
	clc
	adc     #$08
	ldy     #$02
	sta     (sp),y
	ldy     #$06
	lda     (sp),y
	clc
	adc     #$08
	ldy     #$01
	sta     (sp),y
	ldy     #$05
	lda     (sp),y
	clc
	adc     #$03
	ldy     #$00
	sta     (sp),y
	ldy     #$04
	lda     (sp),y
	jsr     _set_sprite
	ldy     #$04
	sta     (sp),y
;
; return id;
;
	ldx     #$00
	lda     (sp),y
;
; }
;
	jmp     incsp5

.endproc

; ---------------------------------------------------------------
; void __near__ load_palettes (void)
; ---------------------------------------------------------------

.segment	"CODE"

.proc	_load_palettes: near

.segment	"CODE"

;
; ppu_addr(0x3F00);
;
	jsr     decsp1
	ldx     #$3F
	lda     #$00
	jsr     _ppu_addr
;
; for (i = 0; i < 32; ++i) {
;
	lda     #$00
	tay
L0AAF:	sta     (sp),y
	cmp     #$20
	bcs     L033C
;
; PPU_DATA = palette[i];
;
	lda     (sp),y
	tay
	lda     _palette,y
	sta     $2007
;
; for (i = 0; i < 32; ++i) {
;
	ldy     #$00
	clc
	lda     #$01
	adc     (sp),y
	jmp     L0AAF
;
; }
;
L033C:	jmp     incsp1

.endproc

; ---------------------------------------------------------------
; void __near__ draw_road (void)
; ---------------------------------------------------------------

.segment	"CODE"

.proc	_draw_road: near

.segment	"CODE"

;
; ppu_off();
;
	jsr     decsp3
	jsr     _ppu_off
;
; for (row = 0; row < 30; ++row) {
;
	lda     #$00
	ldy     #$02
L0AB2:	sta     (sp),y
	cmp     #$1E
	bcs     L034B
;
; ppu_addr(0x2000 + (unsigned int)row * 32);
;
	lda     (sp),y
	ldx     #$00
	jsr     shlax4
	stx     tmp1
	asl     a
	rol     tmp1
	pha
	lda     tmp1
	clc
	adc     #$20
	tax
	pla
	jsr     _ppu_addr
;
; for (col = 0; col < 32; ++col) {
;
	lda     #$00
	ldy     #$01
L0AB1:	sta     (sp),y
	cmp     #$20
	bcs     L034C
;
; if (col < 8 || col >= 24) {
;
	lda     (sp),y
	cmp     #$08
	bcc     L0AB4
	cmp     #$18
	bcc     L0AB6
;
; PPU_DATA = TILE_GRASS;
;
L0AB4:	lda     #$02
;
; } else if (col == 15 || col == 16) {
;
	jmp     L0AB0
L0AB6:	lda     (sp),y
	cmp     #$0F
	beq     L0AB7
	cmp     #$10
	bne     L0ABA
;
; PPU_DATA = ((row & 1) == 0) ? TILE_LINE : TILE_ROAD;
;
L0AB7:	iny
	lda     (sp),y
	and     #$01
	bne     L0ABA
	lda     #$03
	jmp     L0AB0
;
; PPU_DATA = TILE_ROAD;
;
L0ABA:	lda     #$01
L0AB0:	sta     $2007
;
; for (col = 0; col < 32; ++col) {
;
	ldy     #$01
	clc
	tya
	adc     (sp),y
	jmp     L0AB1
;
; for (row = 0; row < 30; ++row) {
;
L034C:	iny
	clc
	lda     #$01
	adc     (sp),y
	jmp     L0AB2
;
; ppu_addr(0x23C0);
;
L034B:	ldx     #$23
	lda     #$C0
	jsr     _ppu_addr
;
; for (attr_row = 0; attr_row < 8; ++attr_row) {
;
	lda     #$00
	tay
L0AB3:	sta     (sp),y
	cmp     #$08
	bcs     L0377
;
; PPU_DATA = 0x55;  // Columns 0-3: grass
;
	lda     #$55
	sta     $2007
;
; PPU_DATA = 0x55;  // Columns 4-7: grass
;
	sta     $2007
;
; PPU_DATA = 0x00;  // Columns 8-11: road
;
	lda     #$00
	sta     $2007
;
; PPU_DATA = 0x00;  // Columns 12-15: road
;
	sta     $2007
;
; PPU_DATA = 0x00;  // Columns 16-19: road
;
	sta     $2007
;
; PPU_DATA = 0x00;  // Columns 20-23: road
;
	sta     $2007
;
; PPU_DATA = 0x55;  // Columns 24-27: grass
;
	lda     #$55
	sta     $2007
;
; PPU_DATA = 0x55;  // Columns 28-31: grass
;
	sta     $2007
;
; for (attr_row = 0; attr_row < 8; ++attr_row) {
;
	clc
	lda     #$01
	adc     (sp),y
	jmp     L0AB3
;
; ppu_on();
;
L0377:	jsr     _ppu_on
;
; }
;
	jmp     incsp3

.endproc

; ---------------------------------------------------------------
; void __near__ prepare_enemy (void)
; ---------------------------------------------------------------

.segment	"CODE"

.proc	_prepare_enemy: near

.segment	"CODE"

;
; enemy_next_x = ROAD_LEFT + 16 + (rnd() & 0x3F);
;
	jsr     _rnd
	and     #$3F
	clc
	adc     #$50
	sta     _enemy_next_x
;
; if (enemy_next_x > ROAD_RIGHT - 24) {
;
	cmp     #$A9
	bcc     L0ABB
;
; enemy_next_x = ROAD_RIGHT - 24;
;
	lda     #$A8
	sta     _enemy_next_x
;
; enemy_warn_timer = 60;  // 1 second warning
;
L0ABB:	lda     #$3C
	sta     _enemy_warn_timer
;
; }
;
	rts

.endproc

; ---------------------------------------------------------------
; void __near__ spawn_enemy (void)
; ---------------------------------------------------------------

.segment	"CODE"

.proc	_spawn_enemy: near

.segment	"CODE"

;
; enemy_x = enemy_next_x;
;
	lda     _enemy_next_x
	sta     _enemy_x
;
; enemy_y = 8;  // Start just below top of screen (ahead of player)
;
	lda     #$08
	sta     _enemy_y
;
; enemy_speed = 1;  // Moves down slowly (player catches up via scroll)
;
	lda     #$01
	sta     _enemy_speed
;
; enemy_on = 1;
;
	sta     _enemy_on
;
; enemy_warn_timer = 0;
;
	lda     #$00
	sta     _enemy_warn_timer
;
; }
;
	rts

.endproc

; ---------------------------------------------------------------
; void __near__ spawn_obstacle (void)
; ---------------------------------------------------------------

.segment	"CODE"

.proc	_spawn_obstacle: near

.segment	"CODE"

;
; for (i = 0; i < 4; ++i) {
;
	jsr     decsp1
	lda     #$00
	tay
L0ABC:	sta     (sp),y
	cmp     #$04
	bcs     L03AF
;
; if (!obs_on[i]) {
;
	lda     (sp),y
	tay
	lda     _obs_on,y
	bne     L03B0
;
; obs_x[i] = ROAD_LEFT + 8 + (rnd() & 0x7F);
;
	lda     #<(_obs_x)
	ldx     #>(_obs_x)
	ldy     #$00
	clc
	adc     (sp),y
	bcc     L03BC
	inx
L03BC:	jsr     pushax
	jsr     _rnd
	and     #$7F
	clc
	adc     #$48
	ldy     #$00
	jsr     staspidx
;
; if (obs_x[i] > ROAD_RIGHT - 16) {
;
	ldy     #$00
	lda     (sp),y
	tay
	lda     _obs_x,y
	cmp     #$B1
	bcc     L03C0
;
; obs_x[i] = ROAD_RIGHT - 16;
;
	ldy     #$00
	lda     (sp),y
	tay
	lda     #$B0
	sta     _obs_x,y
;
; obs_y[i] = 0;
;
L03C0:	ldy     #$00
	lda     (sp),y
	tay
	lda     #$00
	sta     _obs_y,y
;
; obs_on[i] = 1;
;
	tay
	lda     (sp),y
	tay
	lda     #$01
	sta     _obs_on,y
;
; break;
;
	jmp     incsp1
;
; for (i = 0; i < 4; ++i) {
;
L03B0:	ldy     #$00
	clc
	lda     #$01
	adc     (sp),y
	jmp     L0ABC
;
; }
;
L03AF:	jmp     incsp1

.endproc

; ---------------------------------------------------------------
; unsigned char __near__ abs_diff (unsigned char, unsigned char)
; ---------------------------------------------------------------

.segment	"CODE"

.proc	_abs_diff: near

.segment	"CODE"

;
; static unsigned char abs_diff(unsigned char a, unsigned char b) {
;
	jsr     pusha
;
; if (a >= b) return a - b;
;
	ldy     #$01
	ldx     #$00
	lda     (sp),y
	dey
	cmp     (sp),y
	bcc     L0ABF
	iny
	lda     (sp),y
	sec
	dey
	sbc     (sp),y
	jmp     incsp2
;
; return b - a;
;
L0ABF:	lda     (sp),y
	sec
	iny
	sbc     (sp),y
;
; }
;
	jmp     incsp2

.endproc

; ---------------------------------------------------------------
; void __near__ spawn_bullet (unsigned char, unsigned char, signed char, signed char)
; ---------------------------------------------------------------

.segment	"CODE"

.proc	_spawn_bullet: near

.segment	"CODE"

;
; static void spawn_bullet(unsigned char x, unsigned char y, signed char dx, signed char dy) {
;
	jsr     pusha
;
; for (i = 0; i < MAX_BULLETS; ++i) {
;
	jsr     decsp1
	lda     #$00
	tay
L0AC0:	sta     (sp),y
	cmp     #$10
	bcs     L03D7
;
; if (!bullet_on[i]) {
;
	lda     (sp),y
	tay
	lda     _bullet_on,y
	bne     L03D8
;
; bullet_x[i] = x;
;
	tay
	lda     (sp),y
	tax
	ldy     #$04
	lda     (sp),y
	sta     _bullet_x,x
;
; bullet_y[i] = y;
;
	ldy     #$00
	lda     (sp),y
	tax
	ldy     #$03
	lda     (sp),y
	sta     _bullet_y,x
;
; bullet_dx[i] = dx;
;
	lda     #<(_bullet_dx)
	ldx     #>(_bullet_dx)
	ldy     #$00
	clc
	adc     (sp),y
	bcc     L03EC
	inx
L03EC:	sta     ptr1
	stx     ptr1+1
	ldy     #$02
	lda     (sp),y
	ldy     #$00
	sta     (ptr1),y
;
; bullet_dy[i] = dy;
;
	lda     #<(_bullet_dy)
	ldx     #>(_bullet_dy)
	clc
	adc     (sp),y
	bcc     L03F1
	inx
L03F1:	sta     ptr1
	stx     ptr1+1
	iny
	lda     (sp),y
	dey
	sta     (ptr1),y
;
; bullet_on[i] = 1;
;
	lda     (sp),y
	tay
	lda     #$01
	sta     _bullet_on,y
;
; break;
;
	jmp     incsp5
;
; for (i = 0; i < MAX_BULLETS; ++i) {
;
L03D8:	ldy     #$00
	clc
	lda     #$01
	adc     (sp),y
	jmp     L0AC0
;
; }
;
L03D7:	jmp     incsp5

.endproc

; ---------------------------------------------------------------
; void __near__ spawn_danmaku (void)
; ---------------------------------------------------------------

.segment	"CODE"

.proc	_spawn_danmaku: near

.segment	"CODE"

;
; if (!enemy_on) return;
;
	jsr     decsp6
	lda     _enemy_on
	bne     L0ADF
;
; }
;
	jmp     incsp6
;
; if (enemy_y < 24) return;  // Don't shoot while entering screen
;
L0ADF:	lda     _enemy_y
	cmp     #$18
	bcs     L0AE0
;
; }
;
	jmp     incsp6
;
; cx = enemy_x + 8;  // Center X
;
L0AE0:	lda     _enemy_x
	clc
	adc     #$08
	ldy     #$05
	sta     (sp),y
;
; cy = enemy_y + 16; // Bullet spawn Y
;
	lda     _enemy_y
	clc
	adc     #$10
	dey
	sta     (sp),y
;
; ++bullet_timer;
;
	inc     _bullet_timer
;
; if (bullet_timer == 0) {
;
	bne     L0AC7
;
; pattern_type = (pattern_type + 1) & 0x07;
;
	lda     _pattern_type
	clc
	adc     #$01
	and     #$07
	sta     _pattern_type
;
; pattern_phase = 0;
;
	lda     #$00
	sta     _pattern_phase
;
; switch (pattern_type) {
;
L0AC7:	lda     _pattern_type
;
; }
;
	beq     L0AC8
	cmp     #$01
	jeq     L0ACD
	cmp     #$02
	jeq     L0AD0
	cmp     #$03
	jeq     L0AD2
	cmp     #$04
	jeq     L0AD3
	cmp     #$05
	jeq     L0AD5
	cmp     #$06
	jeq     L0AD9
	cmp     #$07
	jeq     L0ADB
	jmp     incsp6
;
; if ((bullet_timer & 0x07) == 0) {
;
L0AC8:	lda     _bullet_timer
	and     #$07
	beq     L0AE1
;
; }
;
	jmp     incsp6
;
; angle_idx = (pattern_phase) & 0x07;
;
L0AE1:	lda     _pattern_phase
	and     #$07
	ldy     #$00
	sta     (sp),y
;
; dx = cos_table[angle_idx];
;
	lda     #<(_cos_table)
	ldx     #>(_cos_table)
	clc
	adc     (sp),y
	bcc     L0AC9
	inx
L0AC9:	jsr     ldaidx
	ldy     #$02
	sta     (sp),y
;
; dy = 1 + ((sin_table[angle_idx] + 2) >> 1);  // 1-2 speed
;
	lda     #<(_sin_table)
	ldx     #>(_sin_table)
	ldy     #$00
	clc
	adc     (sp),y
	bcc     L0ACA
	inx
L0ACA:	jsr     ldaidx
	clc
	adc     #$02
	bcc     L0434
	inx
L0434:	jsr     asrax1
	clc
	adc     #$01
	cmp     #$80
	iny
	sta     (sp),y
;
; spawn_bullet(cx, cy, dx, dy);
;
	jsr     decsp3
	ldy     #$08
	lda     (sp),y
	ldy     #$02
	sta     (sp),y
	ldy     #$07
	lda     (sp),y
	ldy     #$01
	sta     (sp),y
	ldy     #$05
	lda     (sp),y
	ldy     #$00
	sta     (sp),y
	ldy     #$04
	lda     (sp),y
	jsr     _spawn_bullet
;
; angle_idx = (pattern_phase + 4) & 0x07;
;
	lda     _pattern_phase
	clc
	adc     #$04
	and     #$07
	ldy     #$00
	sta     (sp),y
;
; dx = cos_table[angle_idx];
;
	lda     #<(_cos_table)
	ldx     #>(_cos_table)
	clc
	adc     (sp),y
	bcc     L0ACB
	inx
L0ACB:	jsr     ldaidx
	ldy     #$02
	sta     (sp),y
;
; dy = 1 + ((sin_table[angle_idx] + 2) >> 1);
;
	lda     #<(_sin_table)
	ldx     #>(_sin_table)
	ldy     #$00
	clc
	adc     (sp),y
	bcc     L0ACC
	inx
L0ACC:	jsr     ldaidx
	clc
	adc     #$02
	bcc     L044A
	inx
L044A:	jsr     asrax1
	clc
	adc     #$01
	cmp     #$80
	iny
	sta     (sp),y
;
; spawn_bullet(cx, cy, dx, dy);
;
	jsr     decsp3
	ldy     #$08
	lda     (sp),y
	ldy     #$02
	sta     (sp),y
	ldy     #$07
	lda     (sp),y
	ldy     #$01
	sta     (sp),y
	ldy     #$05
	lda     (sp),y
	ldy     #$00
	sta     (sp),y
	ldy     #$04
	lda     (sp),y
	jsr     _spawn_bullet
;
; ++pattern_phase;
;
	inc     _pattern_phase
;
; break;
;
	jmp     incsp6
;
; if ((bullet_timer & 0x1F) == 0) {
;
L0ACD:	lda     _bullet_timer
	and     #$1F
	beq     L0AE2
;
; }
;
	jmp     incsp6
;
; for (i = 0; i < 6; ++i) {
;
L0AE2:	dey
L0AC4:	sta     (sp),y
	cmp     #$06
	bcs     L0ACF
;
; angle_idx = (i + pattern_phase) & 0x07;
;
	lda     (sp),y
	clc
	adc     _pattern_phase
	and     #$07
	ldy     #$00
	sta     (sp),y
;
; dx = cos_table[angle_idx];
;
	lda     #<(_cos_table)
	ldx     #>(_cos_table)
	clc
	adc     (sp),y
	bcc     L0ACE
	inx
L0ACE:	jsr     ldaidx
	ldy     #$02
	sta     (sp),y
;
; dy = 1;
;
	lda     #$01
	dey
	sta     (sp),y
;
; spawn_bullet(cx, cy, dx, dy);
;
	jsr     decsp3
	ldy     #$08
	lda     (sp),y
	ldy     #$02
	sta     (sp),y
	ldy     #$07
	lda     (sp),y
	ldy     #$01
	sta     (sp),y
	ldy     #$05
	lda     (sp),y
	ldy     #$00
	sta     (sp),y
	ldy     #$04
	lda     (sp),y
	jsr     _spawn_bullet
;
; for (i = 0; i < 6; ++i) {
;
	ldy     #$03
	clc
	lda     #$01
	adc     (sp),y
	jmp     L0AC4
;
; ++pattern_phase;
;
L0ACF:	inc     _pattern_phase
;
; break;
;
	jmp     incsp6
;
; if ((bullet_timer & 0x0F) == 0) {
;
L0AD0:	lda     _bullet_timer
	and     #$0F
	beq     L0AE3
;
; }
;
	jmp     incsp6
;
; angle_idx = pattern_phase & 0x07;
;
L0AE3:	lda     _pattern_phase
	and     #$07
	ldy     #$00
	sta     (sp),y
;
; dx = cos_table[angle_idx];
;
	lda     #<(_cos_table)
	ldx     #>(_cos_table)
	clc
	adc     (sp),y
	bcc     L0AD1
	inx
L0AD1:	jsr     ldaidx
	ldy     #$02
	sta     (sp),y
;
; spawn_bullet(cx - 8, cy, dx, 1);
;
	jsr     decsp3
	ldy     #$08
	lda     (sp),y
	sec
	sbc     #$08
	ldy     #$02
	sta     (sp),y
	ldy     #$07
	lda     (sp),y
	ldy     #$01
	sta     (sp),y
	ldy     #$05
	lda     (sp),y
	ldy     #$00
	sta     (sp),y
	lda     #$01
	jsr     _spawn_bullet
;
; dx = cos_table[(angle_idx + 4) & 0x07];
;
	ldy     #$00
	lda     (sp),y
	clc
	adc     #$04
	and     #$07
	clc
	adc     #<(_cos_table)
	tay
	lda     #$00
	adc     #>(_cos_table)
	tax
	tya
	ldy     #$00
	jsr     ldaidx
	ldy     #$02
	sta     (sp),y
;
; spawn_bullet(cx + 8, cy, dx, 1);
;
	jsr     decsp3
	ldy     #$08
	lda     (sp),y
	clc
	adc     #$08
	ldy     #$02
	sta     (sp),y
	ldy     #$07
	lda     (sp),y
	ldy     #$01
	sta     (sp),y
	ldy     #$05
	lda     (sp),y
	ldy     #$00
	sta     (sp),y
	lda     #$01
	jsr     _spawn_bullet
;
; ++pattern_phase;
;
	inc     _pattern_phase
;
; break;
;
	jmp     incsp6
;
; if ((bullet_timer & 0x3F) == 0) {
;
L0AD2:	lda     _bullet_timer
	and     #$3F
	beq     L0AE4
;
; }
;
	jmp     incsp6
;
; spawn_bullet(cx, cy, 0, 2);       // Down
;
L0AE4:	jsr     decsp3
	ldy     #$08
	lda     (sp),y
	ldy     #$02
	sta     (sp),y
	ldy     #$07
	lda     (sp),y
	ldy     #$01
	sta     (sp),y
	lda     #$00
	dey
	sta     (sp),y
	lda     #$02
	jsr     _spawn_bullet
;
; spawn_bullet(cx, cy, 2, 1);       // Down-right
;
	jsr     decsp3
	ldy     #$08
	lda     (sp),y
	ldy     #$02
	sta     (sp),y
	ldy     #$07
	lda     (sp),y
	ldy     #$01
	sta     (sp),y
	lda     #$02
	dey
	sta     (sp),y
	lda     #$01
	jsr     _spawn_bullet
;
; spawn_bullet(cx, cy, 2, -1);      // Up-right (but still moves down overall)
;
	jsr     decsp3
	ldy     #$08
	lda     (sp),y
	ldy     #$02
	sta     (sp),y
	ldy     #$07
	lda     (sp),y
	ldy     #$01
	sta     (sp),y
	lda     #$02
	dey
	sta     (sp),y
	lda     #$FF
	jsr     _spawn_bullet
;
; spawn_bullet(cx, cy, -2, 1);      // Down-left
;
	jsr     decsp3
	ldy     #$08
	lda     (sp),y
	ldy     #$02
	sta     (sp),y
	ldy     #$07
	lda     (sp),y
	ldy     #$01
	sta     (sp),y
	lda     #$FE
	dey
	sta     (sp),y
	lda     #$01
	jsr     _spawn_bullet
;
; spawn_bullet(cx, cy, -2, -1);     // Up-left
;
	jsr     decsp3
	ldy     #$08
	lda     (sp),y
	ldy     #$02
	sta     (sp),y
	ldy     #$07
	lda     (sp),y
	ldy     #$01
	sta     (sp),y
	lda     #$FE
	dey
	sta     (sp),y
	lda     #$FF
	jsr     _spawn_bullet
;
; spawn_bullet(cx, cy, 0, 1);       // Slow down
;
	jsr     decsp3
	ldy     #$08
	lda     (sp),y
	ldy     #$02
	sta     (sp),y
	ldy     #$07
	lda     (sp),y
	ldy     #$01
	sta     (sp),y
	lda     #$00
	dey
	sta     (sp),y
	lda     #$01
	jsr     _spawn_bullet
;
; break;
;
	jmp     incsp6
;
; if ((bullet_timer & 0x0F) == 0) {
;
L0AD3:	lda     _bullet_timer
	and     #$0F
	beq     L0AE5
;
; }
;
	jmp     incsp6
;
; angle_idx = pattern_phase & 0x07;
;
L0AE5:	lda     _pattern_phase
	and     #$07
	ldy     #$00
	sta     (sp),y
;
; dx = sin_table[angle_idx];
;
	lda     #<(_sin_table)
	ldx     #>(_sin_table)
	clc
	adc     (sp),y
	bcc     L0AD4
	inx
L0AD4:	jsr     ldaidx
	ldy     #$02
	sta     (sp),y
;
; spawn_bullet(cx - 16, cy, dx, 1);
;
	jsr     decsp3
	ldy     #$08
	lda     (sp),y
	sec
	sbc     #$10
	ldy     #$02
	sta     (sp),y
	ldy     #$07
	lda     (sp),y
	ldy     #$01
	sta     (sp),y
	ldy     #$05
	lda     (sp),y
	ldy     #$00
	sta     (sp),y
	lda     #$01
	jsr     _spawn_bullet
;
; dx = sin_table[(angle_idx + 4) & 0x07];
;
	ldy     #$00
	lda     (sp),y
	clc
	adc     #$04
	and     #$07
	clc
	adc     #<(_sin_table)
	tay
	lda     #$00
	adc     #>(_sin_table)
	tax
	tya
	ldy     #$00
	jsr     ldaidx
	ldy     #$02
	sta     (sp),y
;
; spawn_bullet(cx + 16, cy, dx, 1);
;
	jsr     decsp3
	ldy     #$08
	lda     (sp),y
	clc
	adc     #$10
	ldy     #$02
	sta     (sp),y
	ldy     #$07
	lda     (sp),y
	ldy     #$01
	sta     (sp),y
	ldy     #$05
	lda     (sp),y
	ldy     #$00
	sta     (sp),y
	lda     #$01
	jsr     _spawn_bullet
;
; ++pattern_phase;
;
	inc     _pattern_phase
;
; break;
;
	jmp     incsp6
;
; if ((bullet_timer & 0x3F) == 0) {
;
L0AD5:	lda     _bullet_timer
	and     #$3F
	beq     L0AE6
;
; }
;
	jmp     incsp6
;
; for (i = 0; i < 8; ++i) {
;
L0AE6:	dey
L0AC5:	sta     (sp),y
	cmp     #$08
	bcs     L0AD8
;
; angle_idx = (i + pattern_phase) & 0x07;
;
	lda     (sp),y
	clc
	adc     _pattern_phase
	and     #$07
	ldy     #$00
	sta     (sp),y
;
; dx = cos_table[angle_idx];
;
	lda     #<(_cos_table)
	ldx     #>(_cos_table)
	clc
	adc     (sp),y
	bcc     L0AD6
	inx
L0AD6:	jsr     ldaidx
	ldy     #$02
	sta     (sp),y
;
; dy = (sin_table[angle_idx] >> 1) + 1;  // Mostly downward
;
	lda     #<(_sin_table)
	ldx     #>(_sin_table)
	ldy     #$00
	clc
	adc     (sp),y
	bcc     L0AD7
	inx
L0AD7:	jsr     ldaidx
	jsr     asrax1
	clc
	adc     #$01
	cmp     #$80
	iny
	sta     (sp),y
;
; spawn_bullet(cx, cy, dx, dy);
;
	jsr     decsp3
	ldy     #$08
	lda     (sp),y
	ldy     #$02
	sta     (sp),y
	ldy     #$07
	lda     (sp),y
	ldy     #$01
	sta     (sp),y
	ldy     #$05
	lda     (sp),y
	ldy     #$00
	sta     (sp),y
	ldy     #$04
	lda     (sp),y
	jsr     _spawn_bullet
;
; for (i = 0; i < 8; ++i) {
;
	ldy     #$03
	clc
	lda     #$01
	adc     (sp),y
	jmp     L0AC5
;
; pattern_phase += 1;
;
L0AD8:	inc     _pattern_phase
;
; break;
;
	jmp     incsp6
;
; if ((bullet_timer & 0x0B) == 0) {  // Prime-ish interval
;
L0AD9:	lda     _bullet_timer
	and     #$0B
	beq     L0AE7
;
; }
;
	jmp     incsp6
;
; angle_idx = (pattern_phase * 5) & 0x07;  // Golden angle approx
;
L0AE7:	tax
	lda     _pattern_phase
	jsr     mulax5
	and     #$07
	ldy     #$00
	sta     (sp),y
;
; dx = cos_table[angle_idx];
;
	lda     #<(_cos_table)
	ldx     #>(_cos_table)
	clc
	adc     (sp),y
	bcc     L0ADA
	inx
L0ADA:	jsr     ldaidx
	ldy     #$02
	sta     (sp),y
;
; dy = 1;
;
	lda     #$01
	dey
	sta     (sp),y
;
; spawn_bullet(cx, cy, dx, dy);
;
	jsr     decsp3
	ldy     #$08
	lda     (sp),y
	ldy     #$02
	sta     (sp),y
	ldy     #$07
	lda     (sp),y
	ldy     #$01
	sta     (sp),y
	ldy     #$05
	lda     (sp),y
	ldy     #$00
	sta     (sp),y
	ldy     #$04
	lda     (sp),y
	jsr     _spawn_bullet
;
; ++pattern_phase;
;
	inc     _pattern_phase
;
; break;
;
	jmp     incsp6
;
; if ((bullet_timer & 0x1F) == 0) {
;
L0ADB:	lda     _bullet_timer
	and     #$1F
	beq     L0AE8
;
; }
;
	jmp     incsp6
;
; spawn_bullet(cx, cy, 0, 2);
;
L0AE8:	jsr     decsp3
	ldy     #$08
	lda     (sp),y
	ldy     #$02
	sta     (sp),y
	ldy     #$07
	lda     (sp),y
	ldy     #$01
	sta     (sp),y
	lda     #$00
	dey
	sta     (sp),y
	lda     #$02
	jsr     _spawn_bullet
;
; spawn_bullet(cx, cy, 0, 1);
;
	jsr     decsp3
	ldy     #$08
	lda     (sp),y
	ldy     #$02
	sta     (sp),y
	ldy     #$07
	lda     (sp),y
	ldy     #$01
	sta     (sp),y
	lda     #$00
	dey
	sta     (sp),y
	lda     #$01
	jsr     _spawn_bullet
;
; if (pattern_phase & 1) {
;
	lda     _pattern_phase
	and     #$01
	beq     L0518
;
; spawn_bullet(cx, cy, 2, 1);
;
	jsr     decsp3
	ldy     #$08
	lda     (sp),y
	ldy     #$02
	sta     (sp),y
	ldy     #$07
	lda     (sp),y
	ldy     #$01
	sta     (sp),y
	lda     #$02
	dey
	sta     (sp),y
	lda     #$01
	jsr     _spawn_bullet
;
; spawn_bullet(cx, cy, -2, 1);
;
	jsr     decsp3
	ldy     #$08
	lda     (sp),y
	ldy     #$02
	sta     (sp),y
	ldy     #$07
	lda     (sp),y
	ldy     #$01
	sta     (sp),y
	lda     #$FE
;
; } else {
;
	jmp     L0ADE
;
; spawn_bullet(cx, cy, 1, 1);
;
L0518:	jsr     decsp3
	ldy     #$08
	lda     (sp),y
	ldy     #$02
	sta     (sp),y
	ldy     #$07
	lda     (sp),y
	ldy     #$01
	sta     (sp),y
	tya
	dey
	sta     (sp),y
	jsr     _spawn_bullet
;
; spawn_bullet(cx, cy, -1, 1);
;
	jsr     decsp3
	ldy     #$08
	lda     (sp),y
	ldy     #$02
	sta     (sp),y
	ldy     #$07
	lda     (sp),y
	ldy     #$01
	sta     (sp),y
	lda     #$FF
L0ADE:	dey
	sta     (sp),y
	lda     #$01
	jsr     _spawn_bullet
;
; ++pattern_phase;
;
	inc     _pattern_phase
;
; }
;
	jmp     incsp6

.endproc

; ---------------------------------------------------------------
; void __near__ update_bullets (void)
; ---------------------------------------------------------------

.segment	"CODE"

.proc	_update_bullets: near

.segment	"CODE"

;
; for (i = 0; i < MAX_BULLETS; ++i) {
;
	jsr     decsp3
	lda     #$00
	ldy     #$02
L0AE9:	sta     (sp),y
	cmp     #$10
	bcc     L0AEB
;
; }
;
	jmp     incsp3
;
; if (bullet_on[i]) {
;
L0AEB:	lda     (sp),y
	tay
	lda     _bullet_on,y
	beq     L0533
;
; nx = bullet_x[i] + bullet_dx[i];
;
	ldy     #$02
	lda     (sp),y
	tay
	lda     _bullet_x,y
	jsr     pusha0
	lda     #<(_bullet_dx)
	ldx     #>(_bullet_dx)
	ldy     #$04
	clc
	adc     (sp),y
	bcc     L0542
	inx
L0542:	ldy     #$00
	jsr     ldaidx
	jsr     tosaddax
	ldy     #$01
	sta     (sp),y
;
; ny = bullet_y[i] + bullet_dy[i];
;
	iny
	lda     (sp),y
	tay
	lda     _bullet_y,y
	jsr     pusha0
	lda     #<(_bullet_dy)
	ldx     #>(_bullet_dy)
	ldy     #$04
	clc
	adc     (sp),y
	bcc     L0548
	inx
L0548:	ldy     #$00
	jsr     ldaidx
	jsr     tosaddax
	ldy     #$00
	sta     (sp),y
;
; if (nx < 8 || nx > 248 || ny > 240) {
;
	iny
	lda     (sp),y
	cmp     #$08
	bcc     L0AEA
	cmp     #$F9
	bcs     L0AEA
	dey
	lda     (sp),y
	cmp     #$F1
	bcc     L0549
;
; bullet_on[i] = 0;
;
L0AEA:	ldy     #$02
	lda     (sp),y
	tay
	lda     #$00
	sta     _bullet_on,y
;
; } else {
;
	jmp     L0533
;
; bullet_x[i] = nx;
;
L0549:	ldy     #$02
	lda     (sp),y
	tax
	dey
	lda     (sp),y
	sta     _bullet_x,x
;
; bullet_y[i] = ny;
;
	iny
	lda     (sp),y
	tax
	ldy     #$00
	lda     (sp),y
	sta     _bullet_y,x
;
; for (i = 0; i < MAX_BULLETS; ++i) {
;
L0533:	ldy     #$02
	clc
	lda     #$01
	adc     (sp),y
	jmp     L0AE9

.endproc

; ---------------------------------------------------------------
; void __near__ check_bullet_collisions (void)
; ---------------------------------------------------------------

.segment	"CODE"

.proc	_check_bullet_collisions: near

.segment	"CODE"

;
; if (player_inv > 0) return;
;
	jsr     decsp3
	lda     _player_inv
	bne     L055D
;
; for (i = 0; i < MAX_BULLETS; ++i) {
;
	ldy     #$02
L0AEC:	sta     (sp),y
	cmp     #$10
	bcs     L055D
;
; if (bullet_on[i]) {
;
	lda     (sp),y
	tay
	lda     _bullet_on,y
	beq     L055E
;
; dx = abs_diff(player_x + 8, bullet_x[i]);
;
	lda     _player_x
	clc
	adc     #$08
	jsr     pusha
	ldy     #$03
	lda     (sp),y
	tay
	lda     _bullet_x,y
	jsr     _abs_diff
	ldy     #$01
	sta     (sp),y
;
; dy = abs_diff(player_y + 8, bullet_y[i]);
;
	lda     _player_y
	clc
	adc     #$08
	jsr     pusha
	ldy     #$03
	lda     (sp),y
	tay
	lda     _bullet_y,y
	jsr     _abs_diff
	ldy     #$00
	sta     (sp),y
;
; if (dx < 10 && dy < 10) {
;
	iny
	lda     (sp),y
	cmp     #$0A
	bcs     L055E
	dey
	lda     (sp),y
	cmp     #$0A
	bcs     L055E
;
; --player_hp;
;
	dec     _player_hp
;
; player_inv = 60;
;
	lda     #$3C
	sta     _player_inv
;
; bullet_on[i] = 0;
;
	ldy     #$02
	lda     (sp),y
	tay
	lda     #$00
	sta     _bullet_on,y
;
; if (player_hp == 0) {
;
	lda     _player_hp
	bne     L055E
;
; game_state = STATE_GAMEOVER; music_play(3);
;
	lda     #$03
	sta     _game_state
	jsr     _music_play
;
; for (i = 0; i < MAX_BULLETS; ++i) {
;
L055E:	ldy     #$02
	clc
	lda     #$01
	adc     (sp),y
	jmp     L0AEC
;
; }
;
L055D:	jmp     incsp3

.endproc

; ---------------------------------------------------------------
; void __near__ init_game (void)
; ---------------------------------------------------------------

.segment	"CODE"

.proc	_init_game: near

.segment	"CODE"

;
; player_x = PLAYER_START_X;
;
	jsr     decsp1
	lda     #$78
	sta     _player_x
;
; player_y = PLAYER_START_Y;
;
	lda     #$C8
	sta     _player_y
;
; player_hp = PLAYER_MAX_HP;
;
	lda     #$05
	sta     _player_hp
;
; player_inv = 0;
;
	lda     #$00
	sta     _player_inv
;
; enemy_on = 0;
;
	sta     _enemy_on
;
; position = 2;
;
	lda     #$02
	sta     _position
;
; lap_count = 0;
;
	lda     #$00
	sta     _lap_count
;
; score = 0;
;
	sta     _score
	sta     _score+1
;
; distance = 0;
;
	sta     _distance
	sta     _distance+1
;
; scroll_y = 0;
;
	sta     _scroll_y
;
; for (i = 0; i < 4; ++i) {
;
	tay
L0AEF:	sta     (sp),y
	cmp     #$04
	bcs     L0AF1
;
; obs_on[i] = 0;
;
	lda     (sp),y
	tay
	lda     #$00
	sta     _obs_on,y
;
; for (i = 0; i < 4; ++i) {
;
	tay
	clc
	lda     #$01
	adc     (sp),y
	jmp     L0AEF
;
; for (i = 0; i < MAX_BULLETS; ++i) {
;
L0AF1:	tya
L0AF0:	sta     (sp),y
	cmp     #$10
	bcs     L0AF2
;
; bullet_on[i] = 0;
;
	lda     (sp),y
	tay
	lda     #$00
	sta     _bullet_on,y
;
; for (i = 0; i < MAX_BULLETS; ++i) {
;
	tay
	clc
	lda     #$01
	adc     (sp),y
	jmp     L0AF0
;
; bullet_timer = 0;
;
L0AF2:	tya
	sta     _bullet_timer
;
; pattern_phase = 0;
;
	sta     _pattern_phase
;
; pattern_type = 0;
;
	sta     _pattern_type
;
; draw_road();
;
	jsr     _draw_road
;
; prepare_enemy();  // Start with warning marker
;
	jsr     _prepare_enemy
;
; }
;
	jmp     incsp1

.endproc

; ---------------------------------------------------------------
; void __near__ update_player (void)
; ---------------------------------------------------------------

.segment	"CODE"

.proc	_update_player: near

.segment	"CODE"

;
; if (pad_now & BTN_LEFT) {
;
	lda     _pad_now
	and     #$02
	beq     L0AF3
;
; if (player_x > ROAD_LEFT) player_x -= PLAYER_SPEED;
;
	lda     _player_x
	cmp     #$41
	bcc     L0AF3
	sec
	sbc     #$02
	sta     _player_x
;
; if (pad_now & BTN_RIGHT) {
;
L0AF3:	lda     _pad_now
	and     #$01
	beq     L0AF4
;
; if (player_x < ROAD_RIGHT - 16) player_x += PLAYER_SPEED;
;
	lda     _player_x
	cmp     #$B0
	bcs     L0AF4
	lda     #$02
	clc
	adc     _player_x
	sta     _player_x
;
; if (pad_now & BTN_UP) {
;
L0AF4:	lda     _pad_now
	and     #$08
	beq     L0AF5
;
; if (player_y > 32) player_y -= PLAYER_SPEED;
;
	lda     _player_y
	cmp     #$21
	bcc     L0AF5
	sec
	sbc     #$02
	sta     _player_y
;
; if (pad_now & BTN_DOWN) {
;
L0AF5:	lda     _pad_now
	and     #$04
	beq     L0AF6
;
; if (player_y < SCREEN_HEIGHT - 32) player_y += PLAYER_SPEED;
;
	lda     _player_y
	cmp     #$D0
	bcs     L0AF6
	lda     #$02
	clc
	adc     _player_y
	sta     _player_y
;
; if (player_x <= ROAD_LEFT + 8 && player_hp < PLAYER_MAX_HP) {
;
L0AF6:	lda     _player_x
	cmp     #$49
	bcs     L0AF9
	lda     _player_hp
	cmp     #$05
	bcs     L0AF9
;
; if ((frame_count & 0x3F) == 0) {
;
	lda     _frame_count
	and     #$3F
	bne     L0AF9
;
; game_state = STATE_PITSTOP;
;
	lda     #$02
	sta     _game_state
;
; pit_timer = 0;
;
	lda     #$00
	sta     _pit_timer
;
; if (player_inv > 0) --player_inv;
;
L0AF9:	lda     _player_inv
	beq     L05E1
	dec     _player_inv
;
; }
;
L05E1:	rts

.endproc

; ---------------------------------------------------------------
; void __near__ update_enemy (void)
; ---------------------------------------------------------------

.segment	"CODE"

.proc	_update_enemy: near

.segment	"CODE"

;
; if (!enemy_on && enemy_warn_timer > 0) {
;
	lda     _enemy_on
	bne     L05E5
	lda     _enemy_warn_timer
	beq     L05E5
;
; --enemy_warn_timer;
;
	dec     _enemy_warn_timer
;
; if (enemy_warn_timer == 0) {
;
	beq     L0B00
;
; }
;
	rts
;
; spawn_enemy();
;
L0B00:	jmp     _spawn_enemy
;
; if (!enemy_on) {
;
L05E5:	lda     _enemy_on
;
; prepare_enemy();
;
	jeq     _prepare_enemy
;
; enemy_y += enemy_speed;
;
	lda     _enemy_speed
	clc
	adc     _enemy_y
	sta     _enemy_y
;
; if ((frame_count & 0x07) == 0) {
;
	lda     _frame_count
	and     #$07
	bne     L0AFF
;
; if (enemy_x + 8 < player_x && enemy_x < ROAD_RIGHT - 24) {
;
	tax
	lda     _enemy_x
	clc
	adc     #$08
	bcc     L05F8
	inx
L05F8:	cmp     _player_x
	txa
	sbc     #$00
	bcs     L05F9
	lda     _enemy_x
	cmp     #$A8
	bcc     L0AFC
L05F9:	jmp     L0AFD
;
; enemy_x += 1;  // Move right to block
;
L0AFC:	inc     _enemy_x
;
; } else if (enemy_x > player_x + 8 && enemy_x > ROAD_LEFT + 8) {
;
	jmp     L0AFF
L0AFD:	lda     _enemy_x
	jsr     pusha0
	lda     _player_x
	clc
	adc     #$08
	bcc     L0600
	ldx     #$01
L0600:	jsr     tosicmp
	bcc     L0AFF
	beq     L0AFF
	lda     _enemy_x
	cmp     #$49
	bcc     L0AFF
;
; enemy_x -= 1;  // Move left to block
;
	dec     _enemy_x
;
; if (enemy_y > SCREEN_HEIGHT) {
;
L0AFF:	lda     _enemy_y
	cmp     #$F1
	bcc     L060E
;
; enemy_on = 0;
;
	lda     #$00
	sta     _enemy_on
;
; score += 50;
;
	lda     #$32
	clc
	adc     _score
	sta     _score
	bcc     L060B
	inc     _score+1
;
; position = 1;
;
L060B:	lda     #$01
	sta     _position
;
; if (lap_count < 3) {
;
	lda     _lap_count
	cmp     #$03
	bcs     L060E
;
; prepare_enemy();  // Show warning for next enemy
;
	jsr     _prepare_enemy
;
; position = 2;
;
	lda     #$02
	sta     _position
;
; }
;
L060E:	rts

.endproc

; ---------------------------------------------------------------
; void __near__ update_obstacles (void)
; ---------------------------------------------------------------

.segment	"CODE"

.proc	_update_obstacles: near

.segment	"CODE"

;
; for (i = 0; i < 4; ++i) {
;
	jsr     decsp1
	lda     #$00
	tay
L0B01:	sta     (sp),y
	cmp     #$04
	bcs     L0615
;
; if (obs_on[i]) {
;
	lda     (sp),y
	tay
	lda     _obs_on,y
	beq     L0616
;
; obs_y[i] += SCROLL_SPEED;
;
	lda     #<(_obs_y)
	ldx     #>(_obs_y)
	ldy     #$00
	clc
	adc     (sp),y
	bcc     L0622
	inx
L0622:	sta     ptr1
	stx     ptr1+1
	lda     (ptr1),y
	clc
	adc     #$02
	sta     (ptr1),y
;
; if (obs_y[i] > SCREEN_HEIGHT) {
;
	lda     (sp),y
	tay
	lda     _obs_y,y
	cmp     #$F1
	bcc     L0616
;
; obs_on[i] = 0;
;
	ldy     #$00
	lda     (sp),y
	tay
	lda     #$00
	sta     _obs_on,y
;
; for (i = 0; i < 4; ++i) {
;
L0616:	ldy     #$00
	clc
	lda     #$01
	adc     (sp),y
	jmp     L0B01
;
; }
;
L0615:	jmp     incsp1

.endproc

; ---------------------------------------------------------------
; void __near__ check_collisions (void)
; ---------------------------------------------------------------

.segment	"CODE"

.proc	_check_collisions: near

.segment	"CODE"

;
; if (player_inv > 0) return;
;
	jsr     decsp3
	lda     _player_inv
	beq     L0B09
;
; }
;
	jmp     incsp3
;
; if (enemy_on) {
;
L0B09:	lda     _enemy_on
	beq     L0B06
;
; dx = abs_diff(player_x, enemy_x);
;
	lda     _player_x
	jsr     pusha
	lda     _enemy_x
	jsr     _abs_diff
	ldy     #$01
	sta     (sp),y
;
; dy = abs_diff(player_y, enemy_y);
;
	lda     _player_y
	jsr     pusha
	lda     _enemy_y
	jsr     _abs_diff
	ldy     #$00
	sta     (sp),y
;
; if (dx < 14 && dy < 14) {
;
	iny
	lda     (sp),y
	cmp     #$0E
	bcs     L0B05
	dey
	lda     (sp),y
	cmp     #$0E
	bcs     L0B05
;
; --player_hp;
;
	dec     _player_hp
;
; player_inv = 60;
;
	lda     #$3C
	sta     _player_inv
;
; if (player_hp == 0) {
;
	lda     _player_hp
	bne     L0B05
;
; game_state = STATE_GAMEOVER; music_play(3);
;
	lda     #$03
	sta     _game_state
	jsr     _music_play
;
; for (i = 0; i < 4; ++i) {
;
L0B05:	lda     #$00
L0B06:	ldy     #$02
L0B02:	sta     (sp),y
	cmp     #$04
	bcs     L0647
;
; if (obs_on[i]) {
;
	lda     (sp),y
	tay
	lda     _obs_on,y
	beq     L0648
;
; dx = abs_diff(player_x, obs_x[i]);
;
	lda     _player_x
	jsr     pusha
	ldy     #$03
	lda     (sp),y
	tay
	lda     _obs_x,y
	jsr     _abs_diff
	ldy     #$01
	sta     (sp),y
;
; dy = abs_diff(player_y, obs_y[i]);
;
	lda     _player_y
	jsr     pusha
	ldy     #$03
	lda     (sp),y
	tay
	lda     _obs_y,y
	jsr     _abs_diff
	ldy     #$00
	sta     (sp),y
;
; if (dx < 12 && dy < 12) {
;
	iny
	lda     (sp),y
	cmp     #$0C
	bcs     L0648
	dey
	lda     (sp),y
	cmp     #$0C
	bcs     L0648
;
; --player_hp;
;
	dec     _player_hp
;
; player_inv = 60;
;
	lda     #$3C
	sta     _player_inv
;
; obs_on[i] = 0;
;
	ldy     #$02
	lda     (sp),y
	tay
	lda     #$00
	sta     _obs_on,y
;
; if (player_hp == 0) {
;
	lda     _player_hp
	bne     L0648
;
; game_state = STATE_GAMEOVER; music_play(3);
;
	lda     #$03
	sta     _game_state
	jsr     _music_play
;
; for (i = 0; i < 4; ++i) {
;
L0648:	ldy     #$02
	clc
	lda     #$01
	adc     (sp),y
	jmp     L0B02
;
; }
;
L0647:	jmp     incsp3

.endproc

; ---------------------------------------------------------------
; void __near__ update_game (void)
; ---------------------------------------------------------------

.segment	"CODE"

.proc	_update_game: near

.segment	"CODE"

;
; update_player();
;
	jsr     _update_player
;
; update_enemy();
;
	jsr     _update_enemy
;
; update_obstacles();
;
	jsr     _update_obstacles
;
; check_collisions();
;
	jsr     _check_collisions
;
; spawn_danmaku();
;
	jsr     _spawn_danmaku
;
; update_bullets();
;
	jsr     _update_bullets
;
; check_bullet_collisions();
;
	jsr     _check_bullet_collisions
;
; ++distance;
;
	inc     _distance
	bne     L0678
	inc     _distance+1
;
; if (distance >= 1000) {
;
L0678:	lda     _distance
	cmp     #$E8
	lda     _distance+1
	sbc     #$03
	bcc     L0B11
;
; distance = 0;
;
	lda     #$00
	sta     _distance
	sta     _distance+1
;
; ++lap_count;
;
	inc     _lap_count
;
; score += 100;
;
	lda     #$64
	clc
	adc     _score
	sta     _score
	bcc     L0680
	inc     _score+1
;
; if (position == 1) score += 100;
;
L0680:	lda     _position
	cmp     #$01
	bne     L0B0A
	lda     #$64
	clc
	adc     _score
	sta     _score
	bcc     L0B0A
	inc     _score+1
;
; player_hp += 3;
;
L0B0A:	lda     #$03
	clc
	adc     _player_hp
	sta     _player_hp
;
; if (player_hp > PLAYER_MAX_HP) {
;
	cmp     #$06
	bcc     L0B0B
;
; player_hp = PLAYER_MAX_HP;
;
	lda     #$05
	sta     _player_hp
;
; if (lap_count >= 3 && position == 1) {
;
L0B0B:	lda     _lap_count
	cmp     #$03
	bcc     L0B11
	lda     _position
	cmp     #$01
	bne     L0B11
;
; game_state = STATE_WIN;
;
	lda     #$04
	sta     _game_state
;
; init_win_animation();
;
	jsr     _init_win_animation
;
; music_play(2);  // Victory fanfare!
;
	lda     #$02
	jsr     _music_play
;
; if ((frame_count & 0x3F) == 0) {
;
L0B11:	lda     _frame_count
	and     #$3F
	bne     L0B12
;
; spawn_obstacle();
;
	jsr     _spawn_obstacle
;
; scroll_y += SCROLL_SPEED;
;
L0B12:	lda     #$02
	clc
	adc     _scroll_y
	sta     _scroll_y
;
; }
;
	rts

.endproc

; ---------------------------------------------------------------
; void __near__ draw_game (void)
; ---------------------------------------------------------------

.segment	"CODE"

.proc	_draw_game: near

.segment	"CODE"

;
; unsigned char id = 0;
;
	lda     #$00
	jsr     pusha
;
; if (player_inv == 0 || (frame_count & 4)) {
;
	jsr     decsp1
	lda     _player_inv
	beq     L0B1A
	lda     _frame_count
	and     #$04
	beq     L069E
;
; id = set_car(id, player_x, player_y, SPR_CAR, 0);
;
L0B1A:	jsr     decsp4
	ldy     #$05
	lda     (sp),y
	ldy     #$03
	sta     (sp),y
	lda     _player_x
	dey
	sta     (sp),y
	lda     _player_y
	dey
	sta     (sp),y
	lda     #$00
	dey
	sta     (sp),y
	jsr     _set_car
	ldy     #$01
	sta     (sp),y
;
; if (!enemy_on && enemy_warn_timer > 0 && (frame_count & 8)) {
;
L069E:	lda     _enemy_on
	bne     L06A9
	lda     _enemy_warn_timer
	beq     L06A9
	lda     _frame_count
	and     #$08
	beq     L06A9
;
; id = set_sprite(id, enemy_next_x + 4, 8, 0x0A, 1 | 0x80);  // Arrow, flipped vertically
;
	jsr     decsp4
	ldy     #$05
	lda     (sp),y
	ldy     #$03
	sta     (sp),y
	lda     _enemy_next_x
	clc
	adc     #$04
	dey
	sta     (sp),y
	lda     #$08
	dey
	sta     (sp),y
	lda     #$0A
	dey
	sta     (sp),y
	lda     #$81
	jsr     _set_sprite
	ldy     #$01
	sta     (sp),y
;
; id = set_sprite(id, enemy_next_x + 4, 16, 0x0A, 1 | 0x80);
;
	jsr     decsp4
	ldy     #$05
	lda     (sp),y
	ldy     #$03
	sta     (sp),y
	lda     _enemy_next_x
	clc
	adc     #$04
	dey
	sta     (sp),y
	lda     #$10
	dey
	sta     (sp),y
	lda     #$0A
	dey
	sta     (sp),y
	lda     #$81
	jsr     _set_sprite
	ldy     #$01
	sta     (sp),y
;
; if (enemy_on) {
;
L06A9:	lda     _enemy_on
	beq     L0B2A
;
; id = set_car(id, enemy_x, enemy_y, SPR_CAR + 4, 1);
;
	jsr     decsp4
	ldy     #$05
	lda     (sp),y
	ldy     #$03
	sta     (sp),y
	lda     _enemy_x
	dey
	sta     (sp),y
	lda     _enemy_y
	dey
	sta     (sp),y
	lda     #$04
	dey
	sta     (sp),y
	lda     #$01
	jsr     _set_car
	ldy     #$01
	sta     (sp),y
;
; for (i = 0; i < 4; ++i) {
;
	lda     #$00
L0B2A:	tay
L0B15:	sta     (sp),y
	cmp     #$04
	bcs     L0B1E
;
; if (obs_on[i]) {
;
	lda     (sp),y
	tay
	lda     _obs_on,y
	beq     L06C9
;
; id = set_sprite(id, obs_x[i], obs_y[i], SPR_OBSTACLE, 2);
;
	jsr     decsp4
	ldy     #$05
	lda     (sp),y
	ldy     #$03
	sta     (sp),y
	iny
	lda     (sp),y
	tay
	lda     _obs_x,y
	ldy     #$02
	sta     (sp),y
	ldy     #$04
	lda     (sp),y
	tay
	lda     _obs_y,y
	ldy     #$01
	sta     (sp),y
	lda     #$08
	dey
	sta     (sp),y
	lda     #$02
	jsr     _set_sprite
	ldy     #$01
	sta     (sp),y
;
; for (i = 0; i < 4; ++i) {
;
L06C9:	ldy     #$00
	clc
	lda     #$01
	adc     (sp),y
	jmp     L0B15
;
; for (i = 0; i < MAX_BULLETS; ++i) {
;
L0B1E:	tya
L0B16:	sta     (sp),y
	cmp     #$10
	bcs     L06DF
;
; if (bullet_on[i] && id < 60) {  // Leave room for HUD
;
	lda     (sp),y
	tay
	lda     _bullet_on,y
	beq     L06E0
	ldy     #$01
	lda     (sp),y
	cmp     #$3C
	bcs     L06E0
;
; id = set_sprite(id, bullet_x[i], bullet_y[i], SPR_BULLET, 1);
;
	jsr     decsp4
	ldy     #$05
	lda     (sp),y
	ldy     #$03
	sta     (sp),y
	iny
	lda     (sp),y
	tay
	lda     _bullet_x,y
	ldy     #$02
	sta     (sp),y
	ldy     #$04
	lda     (sp),y
	tay
	lda     _bullet_y,y
	ldy     #$01
	sta     (sp),y
	lda     #$0B
	dey
	sta     (sp),y
	lda     #$01
	jsr     _set_sprite
	ldy     #$01
	sta     (sp),y
;
; for (i = 0; i < MAX_BULLETS; ++i) {
;
L06E0:	ldy     #$00
	clc
	lda     #$01
	adc     (sp),y
	jmp     L0B16
;
; id = set_sprite(id, 8, 8, SPR_LETTER + 15, 3);  // P
;
L06DF:	jsr     decsp4
	ldy     #$05
	lda     (sp),y
	ldy     #$03
	sta     (sp),y
	lda     #$08
	dey
	sta     (sp),y
	dey
	sta     (sp),y
	lda     #$3F
	dey
	sta     (sp),y
	lda     #$03
	jsr     _set_sprite
	ldy     #$01
	sta     (sp),y
;
; id = set_sprite(id, 16, 8, SPR_DIGIT + position, 3);
;
	jsr     decsp4
	ldy     #$05
	lda     (sp),y
	ldy     #$03
	sta     (sp),y
	lda     #$10
	dey
	sta     (sp),y
	lda     #$08
	dey
	sta     (sp),y
	lda     _position
	clc
	adc     #$10
	dey
	sta     (sp),y
	lda     #$03
	jsr     _set_sprite
	ldy     #$01
	sta     (sp),y
;
; id = set_sprite(id, 8, 20, SPR_LETTER + 7, 3);  // H
;
	jsr     decsp4
	ldy     #$05
	lda     (sp),y
	ldy     #$03
	sta     (sp),y
	lda     #$08
	dey
	sta     (sp),y
	lda     #$14
	dey
	sta     (sp),y
	lda     #$37
	dey
	sta     (sp),y
	lda     #$03
	jsr     _set_sprite
	ldy     #$01
	sta     (sp),y
;
; id = set_sprite(id, 16, 20, SPR_DIGIT + player_hp, 3);
;
	jsr     decsp4
	ldy     #$05
	lda     (sp),y
	ldy     #$03
	sta     (sp),y
	lda     #$10
	dey
	sta     (sp),y
	lda     #$14
	dey
	sta     (sp),y
	lda     _player_hp
	clc
	adc     #$10
	dey
	sta     (sp),y
	lda     #$03
	jsr     _set_sprite
	ldy     #$01
	sta     (sp),y
;
; id = set_sprite(id, 100, 8, SPR_LETTER + 11, 3);  // L
;
	jsr     decsp4
	ldy     #$05
	lda     (sp),y
	ldy     #$03
	sta     (sp),y
	lda     #$64
	dey
	sta     (sp),y
	lda     #$08
	dey
	sta     (sp),y
	lda     #$3B
	dey
	sta     (sp),y
	lda     #$03
	jsr     _set_sprite
	ldy     #$01
	sta     (sp),y
;
; id = set_sprite(id, 108, 8, SPR_LETTER + 0, 3);   // A
;
	jsr     decsp4
	ldy     #$05
	lda     (sp),y
	ldy     #$03
	sta     (sp),y
	lda     #$6C
	dey
	sta     (sp),y
	lda     #$08
	dey
	sta     (sp),y
	lda     #$30
	dey
	sta     (sp),y
	lda     #$03
	jsr     _set_sprite
	ldy     #$01
	sta     (sp),y
;
; id = set_sprite(id, 116, 8, SPR_LETTER + 15, 3);  // P
;
	jsr     decsp4
	ldy     #$05
	lda     (sp),y
	ldy     #$03
	sta     (sp),y
	lda     #$74
	dey
	sta     (sp),y
	lda     #$08
	dey
	sta     (sp),y
	lda     #$3F
	dey
	sta     (sp),y
	lda     #$03
	jsr     _set_sprite
	ldy     #$01
	sta     (sp),y
;
; id = set_sprite(id, 128, 8, SPR_DIGIT + lap_count + 1, 3);  // Current lap
;
	jsr     decsp4
	ldy     #$05
	lda     (sp),y
	ldy     #$03
	sta     (sp),y
	lda     #$80
	dey
	sta     (sp),y
	lda     #$08
	dey
	sta     (sp),y
	lda     _lap_count
	clc
	adc     #$10
	bcc     L0B19
	clc
L0B19:	adc     #$01
	dey
	sta     (sp),y
	lda     #$03
	jsr     _set_sprite
	ldy     #$01
	sta     (sp),y
;
; id = set_sprite(id, 136, 8, SPR_SLASH, 3);        // "/"
;
	jsr     decsp4
	ldy     #$05
	lda     (sp),y
	ldy     #$03
	sta     (sp),y
	lda     #$88
	dey
	sta     (sp),y
	lda     #$08
	dey
	sta     (sp),y
	lda     #$05
	dey
	sta     (sp),y
	lda     #$03
	jsr     _set_sprite
	ldy     #$01
	sta     (sp),y
;
; id = set_sprite(id, 144, 8, SPR_DIGIT + 3, 3);    // 3 (total laps)
;
	jsr     decsp4
	ldy     #$05
	lda     (sp),y
	ldy     #$03
	sta     (sp),y
	lda     #$90
	dey
	sta     (sp),y
	lda     #$08
	dey
	sta     (sp),y
	lda     #$13
	dey
	sta     (sp),y
	lda     #$03
	jsr     _set_sprite
	ldy     #$01
	sta     (sp),y
;
; progress = (unsigned char)(distance / 10);
;
	jsr     decsp4
	lda     _distance
	ldx     _distance+1
	jsr     pushax
	lda     #$0A
	jsr     tosudiva0
	ldy     #$03
	sta     (sp),y
;
; if (progress > 100) progress = 100;
;
	cmp     #$65
	lda     #$00
	bcc     L0B23
	lda     #$64
	sta     (sp),y
;
; for (bar_x = 0; bar_x < 8 && id < 58; ++bar_x) {
;
	lda     #$00
L0B23:	dey
L0B17:	sta     (sp),y
	cmp     #$08
	bcs     L0749
	ldy     #$05
	lda     (sp),y
	cmp     #$3A
	bcs     L0749
;
; id = set_sprite(id, 64 + bar_x * 10, 224, SPR_BAR_EMPTY, 3);
;
	jsr     decsp4
	ldy     #$09
	lda     (sp),y
	ldy     #$03
	sta     (sp),y
	ldy     #$06
	ldx     #$00
	lda     (sp),y
	jsr     mulax10
	clc
	adc     #$40
	ldy     #$02
	sta     (sp),y
	lda     #$E0
	dey
	sta     (sp),y
	lda     #$07
	dey
	sta     (sp),y
	lda     #$03
	jsr     _set_sprite
	ldy     #$05
	sta     (sp),y
;
; for (bar_x = 0; bar_x < 8 && id < 58; ++bar_x) {
;
	ldy     #$02
	clc
	lda     #$01
	adc     (sp),y
	jmp     L0B17
;
; bar_filled = progress / 13;  // 0-7 segments
;
L0749:	ldy     #$03
	lda     (sp),y
	jsr     pusha0
	lda     #$0D
	jsr     tosudiva0
	ldy     #$01
	sta     (sp),y
;
; for (bar_x = 0; bar_x < bar_filled && bar_x < 8 && id < 60; ++bar_x) {
;
	lda     #$00
	iny
L0B18:	sta     (sp),y
	ldx     #$00
	lda     (sp),y
	dey
	cmp     (sp),y
	bcs     L075D
	iny
	lda     (sp),y
	cmp     #$08
	bcs     L075D
	ldy     #$05
	lda     (sp),y
	cmp     #$3C
	bcs     L075D
;
; id = set_sprite(id, 64 + bar_x * 10, 224, SPR_BAR_FILL, 3);
;
	jsr     decsp4
	ldy     #$09
	lda     (sp),y
	ldy     #$03
	sta     (sp),y
	ldy     #$06
	lda     (sp),y
	jsr     mulax10
	clc
	adc     #$40
	ldy     #$02
	sta     (sp),y
	lda     #$E0
	dey
	sta     (sp),y
	lda     #$06
	dey
	sta     (sp),y
	lda     #$03
	jsr     _set_sprite
	ldy     #$05
	sta     (sp),y
;
; for (bar_x = 0; bar_x < bar_filled && bar_x < 8 && id < 60; ++bar_x) {
;
	ldy     #$02
	clc
	lda     #$01
	adc     (sp),y
	jmp     L0B18
;
; car_pos = 64 + ((progress * 70) / 100);
;
L075D:	ldy     #$03
	lda     (sp),y
	jsr     pusha0
	lda     #$46
	jsr     tosumula0
	jsr     pushax
	lda     #$64
	jsr     tosudiva0
	clc
	adc     #$40
	ldy     #$00
	sta     (sp),y
;
; id = set_sprite(id, car_pos, 216, SPR_CAR_ICON, 0);
;
	jsr     decsp4
	ldy     #$09
	lda     (sp),y
	ldy     #$03
	sta     (sp),y
	iny
	lda     (sp),y
	ldy     #$02
	sta     (sp),y
	lda     #$D8
	dey
	sta     (sp),y
	lda     #$08
	dey
	sta     (sp),y
	tya
	jsr     _set_sprite
	ldy     #$05
	sta     (sp),y
;
; id = set_sprite(id, 152, 224, SPR_LETTER + 6, 3);  // G
;
	jsr     decsp4
	ldy     #$09
	lda     (sp),y
	ldy     #$03
	sta     (sp),y
	lda     #$98
	dey
	sta     (sp),y
	lda     #$E0
	dey
	sta     (sp),y
	lda     #$36
	dey
	sta     (sp),y
	lda     #$03
	jsr     _set_sprite
	ldy     #$05
	sta     (sp),y
;
; id = set_sprite(id, 160, 224, SPR_LETTER + 14, 3); // O
;
	jsr     decsp4
	ldy     #$09
	lda     (sp),y
	ldy     #$03
	sta     (sp),y
	lda     #$A0
	dey
	sta     (sp),y
	lda     #$E0
	dey
	sta     (sp),y
	lda     #$3E
	dey
	sta     (sp),y
	lda     #$03
	jsr     _set_sprite
	ldy     #$05
	sta     (sp),y
;
; id = set_sprite(id, 168, 224, SPR_LETTER + 0, 3);  // A
;
	jsr     decsp4
	ldy     #$09
	lda     (sp),y
	ldy     #$03
	sta     (sp),y
	lda     #$A8
	dey
	sta     (sp),y
	lda     #$E0
	dey
	sta     (sp),y
	lda     #$30
	dey
	sta     (sp),y
	lda     #$03
	jsr     _set_sprite
	ldy     #$05
	sta     (sp),y
;
; id = set_sprite(id, 176, 224, SPR_LETTER + 11, 3); // L
;
	jsr     decsp4
	ldy     #$09
	lda     (sp),y
	ldy     #$03
	sta     (sp),y
	lda     #$B0
	dey
	sta     (sp),y
	lda     #$E0
	dey
	sta     (sp),y
	lda     #$3B
	dey
	sta     (sp),y
	lda     #$03
	jsr     _set_sprite
	ldy     #$05
	sta     (sp),y
;
; }
;
	jsr     incsp4
;
; while (id < 64) {
;
	jmp     L0798
;
; OAM[id * 4] = 0xFF;
;
L0B29:	lda     (sp),y
	jsr     shlax2
	inx
	inx
	sta     ptr1
	stx     ptr1+1
	lda     #$FF
	dey
	sta     (ptr1),y
;
; ++id;
;
	iny
	clc
	tya
	adc     (sp),y
	sta     (sp),y
;
; while (id < 64) {
;
L0798:	ldy     #$01
	ldx     #$00
	lda     (sp),y
	cmp     #$40
	bcc     L0B29
;
; }
;
	jmp     incsp2

.endproc

; ---------------------------------------------------------------
; void __near__ draw_title (void)
; ---------------------------------------------------------------

.segment	"CODE"

.proc	_draw_title: near

.segment	"CODE"

;
; unsigned char id = 0;
;
	lda     #$00
	jsr     pusha
;
; unsigned char x = 100, y = 100;
;
	lda     #$64
	jsr     pusha
	jsr     pusha
;
; id = set_sprite(id, x,      y, SPR_LETTER + 17, 0);  // R
;
	jsr     decsp4
	ldy     #$06
	lda     (sp),y
	ldy     #$03
	sta     (sp),y
	ldy     #$05
	lda     (sp),y
	ldy     #$02
	sta     (sp),y
	ldy     #$04
	lda     (sp),y
	ldy     #$01
	sta     (sp),y
	lda     #$41
	dey
	sta     (sp),y
	tya
	jsr     _set_sprite
	ldy     #$02
	sta     (sp),y
;
; id = set_sprite(id, x + 8,  y, SPR_LETTER + 0,  0);  // A
;
	jsr     decsp4
	ldy     #$06
	lda     (sp),y
	ldy     #$03
	sta     (sp),y
	ldy     #$05
	lda     (sp),y
	clc
	adc     #$08
	ldy     #$02
	sta     (sp),y
	ldy     #$04
	lda     (sp),y
	ldy     #$01
	sta     (sp),y
	lda     #$30
	dey
	sta     (sp),y
	tya
	jsr     _set_sprite
	ldy     #$02
	sta     (sp),y
;
; id = set_sprite(id, x + 16, y, SPR_LETTER + 2,  0);  // C
;
	jsr     decsp4
	ldy     #$06
	lda     (sp),y
	ldy     #$03
	sta     (sp),y
	ldy     #$05
	lda     (sp),y
	clc
	adc     #$10
	ldy     #$02
	sta     (sp),y
	ldy     #$04
	lda     (sp),y
	ldy     #$01
	sta     (sp),y
	lda     #$32
	dey
	sta     (sp),y
	tya
	jsr     _set_sprite
	ldy     #$02
	sta     (sp),y
;
; id = set_sprite(id, x + 24, y, SPR_LETTER + 4,  0);  // E
;
	jsr     decsp4
	ldy     #$06
	lda     (sp),y
	ldy     #$03
	sta     (sp),y
	ldy     #$05
	lda     (sp),y
	clc
	adc     #$18
	ldy     #$02
	sta     (sp),y
	ldy     #$04
	lda     (sp),y
	ldy     #$01
	sta     (sp),y
	lda     #$34
	dey
	sta     (sp),y
	tya
	jsr     _set_sprite
	ldy     #$02
	sta     (sp),y
;
; if (frame_count & 0x20) {
;
	lda     _frame_count
	ldx     #$00
	and     #$20
	beq     L0B2F
;
; id = set_car(id, x + 4, y + 24, SPR_CAR, 0);
;
	jsr     decsp4
	ldy     #$06
	lda     (sp),y
	ldy     #$03
	sta     (sp),y
	ldy     #$05
	lda     (sp),y
	clc
	adc     #$04
	ldy     #$02
	sta     (sp),y
	ldy     #$04
	lda     (sp),y
	clc
	adc     #$18
	ldy     #$01
	sta     (sp),y
	txa
	dey
	sta     (sp),y
	jsr     _set_car
	ldy     #$02
;
; while (id < 64) {
;
	jmp     L0B2B
;
; OAM[id * 4] = 0xFF;
;
L0B2D:	lda     (sp),y
	jsr     shlax2
	inx
	inx
	sta     ptr1
	stx     ptr1+1
	lda     #$FF
	ldy     #$00
	sta     (ptr1),y
;
; ++id;
;
	ldy     #$02
	clc
	lda     #$01
	adc     (sp),y
L0B2B:	sta     (sp),y
;
; while (id < 64) {
;
	ldx     #$00
L0B2F:	lda     (sp),y
	cmp     #$40
	bcc     L0B2D
;
; }
;
	jmp     incsp3

.endproc

; ---------------------------------------------------------------
; void __near__ draw_gameover (void)
; ---------------------------------------------------------------

.segment	"CODE"

.proc	_draw_gameover: near

.segment	"CODE"

;
; unsigned char id = 0;
;
	lda     #$00
	jsr     pusha
;
; unsigned char x = 88, y = 100;
;
	lda     #$58
	jsr     pusha
	lda     #$64
	jsr     pusha
;
; id = set_sprite(id, x,      y, SPR_LETTER + 6,  1);  // G
;
	jsr     decsp4
	ldy     #$06
	lda     (sp),y
	ldy     #$03
	sta     (sp),y
	ldy     #$05
	lda     (sp),y
	ldy     #$02
	sta     (sp),y
	ldy     #$04
	lda     (sp),y
	ldy     #$01
	sta     (sp),y
	lda     #$36
	dey
	sta     (sp),y
	lda     #$01
	jsr     _set_sprite
	ldy     #$02
	sta     (sp),y
;
; id = set_sprite(id, x + 8,  y, SPR_LETTER + 0,  1);  // A
;
	jsr     decsp4
	ldy     #$06
	lda     (sp),y
	ldy     #$03
	sta     (sp),y
	ldy     #$05
	lda     (sp),y
	clc
	adc     #$08
	ldy     #$02
	sta     (sp),y
	ldy     #$04
	lda     (sp),y
	ldy     #$01
	sta     (sp),y
	lda     #$30
	dey
	sta     (sp),y
	lda     #$01
	jsr     _set_sprite
	ldy     #$02
	sta     (sp),y
;
; id = set_sprite(id, x + 16, y, SPR_LETTER + 12, 1);  // M
;
	jsr     decsp4
	ldy     #$06
	lda     (sp),y
	ldy     #$03
	sta     (sp),y
	ldy     #$05
	lda     (sp),y
	clc
	adc     #$10
	ldy     #$02
	sta     (sp),y
	ldy     #$04
	lda     (sp),y
	ldy     #$01
	sta     (sp),y
	lda     #$3C
	dey
	sta     (sp),y
	lda     #$01
	jsr     _set_sprite
	ldy     #$02
	sta     (sp),y
;
; id = set_sprite(id, x + 24, y, SPR_LETTER + 4,  1);  // E
;
	jsr     decsp4
	ldy     #$06
	lda     (sp),y
	ldy     #$03
	sta     (sp),y
	ldy     #$05
	lda     (sp),y
	clc
	adc     #$18
	ldy     #$02
	sta     (sp),y
	ldy     #$04
	lda     (sp),y
	ldy     #$01
	sta     (sp),y
	lda     #$34
	dey
	sta     (sp),y
	lda     #$01
	jsr     _set_sprite
	ldy     #$02
	sta     (sp),y
;
; x = 96; y = 116;
;
	lda     #$60
	dey
	sta     (sp),y
	lda     #$74
	dey
	sta     (sp),y
;
; id = set_sprite(id, x,      y, SPR_LETTER + 14, 1);  // O
;
	jsr     decsp4
	ldy     #$06
	lda     (sp),y
	ldy     #$03
	sta     (sp),y
	ldy     #$05
	lda     (sp),y
	ldy     #$02
	sta     (sp),y
	ldy     #$04
	lda     (sp),y
	ldy     #$01
	sta     (sp),y
	lda     #$3E
	dey
	sta     (sp),y
	lda     #$01
	jsr     _set_sprite
	ldy     #$02
	sta     (sp),y
;
; id = set_sprite(id, x + 8,  y, SPR_LETTER + 21, 1);  // V
;
	jsr     decsp4
	ldy     #$06
	lda     (sp),y
	ldy     #$03
	sta     (sp),y
	ldy     #$05
	lda     (sp),y
	clc
	adc     #$08
	ldy     #$02
	sta     (sp),y
	ldy     #$04
	lda     (sp),y
	ldy     #$01
	sta     (sp),y
	lda     #$45
	dey
	sta     (sp),y
	lda     #$01
	jsr     _set_sprite
	ldy     #$02
	sta     (sp),y
;
; id = set_sprite(id, x + 16, y, SPR_LETTER + 4,  1);  // E
;
	jsr     decsp4
	ldy     #$06
	lda     (sp),y
	ldy     #$03
	sta     (sp),y
	ldy     #$05
	lda     (sp),y
	clc
	adc     #$10
	ldy     #$02
	sta     (sp),y
	ldy     #$04
	lda     (sp),y
	ldy     #$01
	sta     (sp),y
	lda     #$34
	dey
	sta     (sp),y
	lda     #$01
	jsr     _set_sprite
	ldy     #$02
	sta     (sp),y
;
; id = set_sprite(id, x + 24, y, SPR_LETTER + 17, 1);  // R
;
	jsr     decsp4
	ldy     #$06
	lda     (sp),y
	ldy     #$03
	sta     (sp),y
	ldy     #$05
	lda     (sp),y
	clc
	adc     #$18
	ldy     #$02
	sta     (sp),y
	ldy     #$04
	lda     (sp),y
	ldy     #$01
	sta     (sp),y
	lda     #$41
	dey
	sta     (sp),y
	lda     #$01
	jsr     _set_sprite
	ldy     #$02
;
; while (id < 64) {
;
	jmp     L0B30
;
; OAM[id * 4] = 0xFF;
;
L0B32:	lda     (sp),y
	jsr     shlax2
	inx
	inx
	sta     ptr1
	stx     ptr1+1
	lda     #$FF
	ldy     #$00
	sta     (ptr1),y
;
; ++id;
;
	ldy     #$02
	clc
	lda     #$01
	adc     (sp),y
L0B30:	sta     (sp),y
;
; while (id < 64) {
;
	ldx     #$00
	lda     (sp),y
	cmp     #$40
	bcc     L0B32
;
; }
;
	jmp     incsp3

.endproc

; ---------------------------------------------------------------
; void __near__ update_win_animation (void)
; ---------------------------------------------------------------

.segment	"CODE"

.proc	_update_win_animation: near

.segment	"CODE"

;
; ++win_timer;
;
	jsr     decsp1
	inc     _win_timer
;
; for (i = 0; i < MAX_CONFETTI; ++i) {
;
	lda     #$00
	tay
L0B35:	sta     (sp),y
	cmp     #$0C
	bcc     L0B37
;
; }
;
	jmp     incsp1
;
; confetti_y[i] += 1 + (i & 1);  // Different speeds
;
L0B37:	lda     #<(_confetti_y)
	ldx     #>(_confetti_y)
	clc
	adc     (sp),y
	bcc     L084B
	inx
L084B:	jsr     pushax
	sta     ptr1
	stx     ptr1+1
	ldy     #$00
	lda     (ptr1),y
	sta     ptr1
	ldy     #$02
	lda     (sp),y
	and     #$01
	clc
	adc     #$01
	bcc     L0B36
	clc
L0B36:	adc     ptr1
	ldy     #$00
	jsr     staspidx
;
; if (frame_count & 2) {
;
	lda     _frame_count
	and     #$02
	beq     L084F
;
; if (i & 1) {
;
	ldy     #$00
	lda     (sp),y
	and     #$01
	beq     L0851
;
; confetti_x[i] += 1;
;
	lda     #<(_confetti_x)
	ldx     #>(_confetti_x)
	clc
	adc     (sp),y
	bcc     L0855
	inx
L0855:	sta     ptr1
	stx     ptr1+1
	lda     (ptr1),y
	clc
	adc     #$01
;
; } else {
;
	jmp     L0B34
;
; confetti_x[i] -= 1;
;
L0851:	lda     #<(_confetti_x)
	ldx     #>(_confetti_x)
	clc
	adc     (sp),y
	bcc     L085A
	inx
L085A:	sta     ptr1
	stx     ptr1+1
	lda     (ptr1),y
	sec
	sbc     #$01
L0B34:	sta     (ptr1),y
;
; if (confetti_y[i] > 240) {
;
L084F:	ldy     #$00
	lda     (sp),y
	tay
	lda     _confetti_y,y
	cmp     #$F1
	bcc     L0843
;
; confetti_y[i] = 0;
;
	ldy     #$00
	lda     (sp),y
	tay
	lda     #$00
	sta     _confetti_y,y
;
; confetti_x[i] = 32 + (rnd() & 0x7F) + (rnd() & 0x3F);
;
	lda     #<(_confetti_x)
	ldx     #>(_confetti_x)
	ldy     #$00
	clc
	adc     (sp),y
	bcc     L0866
	inx
L0866:	jsr     pushax
	jsr     _rnd
	ldx     #$00
	and     #$7F
	clc
	adc     #$20
	bcc     L0869
	inx
L0869:	jsr     pushax
	jsr     _rnd
	and     #$3F
	jsr     tosadda0
	ldy     #$00
	jsr     staspidx
;
; for (i = 0; i < MAX_CONFETTI; ++i) {
;
L0843:	ldy     #$00
	clc
	lda     #$01
	adc     (sp),y
	jmp     L0B35

.endproc

; ---------------------------------------------------------------
; void __near__ draw_win (void)
; ---------------------------------------------------------------

.segment	"CODE"

.proc	_draw_win: near

.segment	"CODE"

;
; unsigned char id = 0;
;
	lda     #$00
	jsr     pusha
;
; bounce = 0;
;
	jsr     decsp7
	lda     #$00
	tay
	sta     (sp),y
;
; if (win_timer < 60) {
;
	lda     _win_timer
	cmp     #$3C
	bcs     L0B3B
;
; bounce = (win_timer >> 2) & 0x03;
;
	lsr     a
	lsr     a
	and     #$03
	sta     (sp),y
;
; if (bounce > 2) bounce = 4 - bounce;
;
	cmp     #$03
	tya
	bcc     L0B3C
	lda     #$04
	sec
	sbc     (sp),y
	sta     (sp),y
;
; for (i = 0; i < MAX_CONFETTI && id < 20; ++i) {
;
L0B3B:	tya
L0B3C:	ldy     #$02
L0B39:	sta     (sp),y
	cmp     #$0C
	bcs     L0B3F
	ldy     #$07
	lda     (sp),y
	cmp     #$14
	bcs     L0B3F
;
; id = set_sprite(id, confetti_x[i], confetti_y[i],
;
	jsr     decsp4
	ldy     #$0B
	lda     (sp),y
	ldy     #$03
	sta     (sp),y
	ldy     #$06
	lda     (sp),y
	tay
	lda     _confetti_x,y
	ldy     #$02
	sta     (sp),y
	ldy     #$06
	lda     (sp),y
	tay
	lda     _confetti_y,y
	ldy     #$01
	sta     (sp),y
;
; SPR_BULLET + (i & 1), confetti_color[i]);
;
	ldy     #$06
	lda     (sp),y
	and     #$01
	clc
	adc     #$0B
	ldy     #$00
	sta     (sp),y
	ldy     #$06
	lda     (sp),y
	tay
	lda     _confetti_color,y
	jsr     _set_sprite
	ldy     #$07
	sta     (sp),y
;
; for (i = 0; i < MAX_CONFETTI && id < 20; ++i) {
;
	ldy     #$02
	clc
	lda     #$01
	adc     (sp),y
	jmp     L0B39
;
; text_y = 60 - bounce;
;
L0B3F:	lda     #$3C
	sec
	ldy     #$00
	sbc     (sp),y
	iny
	sta     (sp),y
;
; x = 84;
;
	lda     #$54
	ldy     #$06
	sta     (sp),y
;
; id = set_sprite(id, x,      text_y, SPR_LETTER + 5,  0);  // F
;
	jsr     decsp4
	ldy     #$0B
	lda     (sp),y
	ldy     #$03
	sta     (sp),y
	ldy     #$0A
	lda     (sp),y
	ldy     #$02
	sta     (sp),y
	ldy     #$05
	lda     (sp),y
	ldy     #$01
	sta     (sp),y
	lda     #$35
	dey
	sta     (sp),y
	tya
	jsr     _set_sprite
	ldy     #$07
	sta     (sp),y
;
; id = set_sprite(id, x + 8,  text_y, SPR_LETTER + 8,  0);  // I
;
	jsr     decsp4
	ldy     #$0B
	lda     (sp),y
	ldy     #$03
	sta     (sp),y
	ldy     #$0A
	lda     (sp),y
	clc
	adc     #$08
	ldy     #$02
	sta     (sp),y
	ldy     #$05
	lda     (sp),y
	ldy     #$01
	sta     (sp),y
	lda     #$38
	dey
	sta     (sp),y
	tya
	jsr     _set_sprite
	ldy     #$07
	sta     (sp),y
;
; id = set_sprite(id, x + 16, text_y, SPR_LETTER + 13, 0);  // N
;
	jsr     decsp4
	ldy     #$0B
	lda     (sp),y
	ldy     #$03
	sta     (sp),y
	ldy     #$0A
	lda     (sp),y
	clc
	adc     #$10
	ldy     #$02
	sta     (sp),y
	ldy     #$05
	lda     (sp),y
	ldy     #$01
	sta     (sp),y
	lda     #$3D
	dey
	sta     (sp),y
	tya
	jsr     _set_sprite
	ldy     #$07
	sta     (sp),y
;
; id = set_sprite(id, x + 24, text_y, SPR_LETTER + 8,  0);  // I
;
	jsr     decsp4
	ldy     #$0B
	lda     (sp),y
	ldy     #$03
	sta     (sp),y
	ldy     #$0A
	lda     (sp),y
	clc
	adc     #$18
	ldy     #$02
	sta     (sp),y
	ldy     #$05
	lda     (sp),y
	ldy     #$01
	sta     (sp),y
	lda     #$38
	dey
	sta     (sp),y
	tya
	jsr     _set_sprite
	ldy     #$07
	sta     (sp),y
;
; id = set_sprite(id, x + 32, text_y, SPR_LETTER + 18, 0);  // S
;
	jsr     decsp4
	ldy     #$0B
	lda     (sp),y
	ldy     #$03
	sta     (sp),y
	ldy     #$0A
	lda     (sp),y
	clc
	adc     #$20
	ldy     #$02
	sta     (sp),y
	ldy     #$05
	lda     (sp),y
	ldy     #$01
	sta     (sp),y
	lda     #$42
	dey
	sta     (sp),y
	tya
	jsr     _set_sprite
	ldy     #$07
	sta     (sp),y
;
; id = set_sprite(id, x + 40, text_y, SPR_LETTER + 7,  0);  // H
;
	jsr     decsp4
	ldy     #$0B
	lda     (sp),y
	ldy     #$03
	sta     (sp),y
	ldy     #$0A
	lda     (sp),y
	clc
	adc     #$28
	ldy     #$02
	sta     (sp),y
	ldy     #$05
	lda     (sp),y
	ldy     #$01
	sta     (sp),y
	lda     #$37
	dey
	sta     (sp),y
	tya
	jsr     _set_sprite
	ldy     #$07
	sta     (sp),y
;
; y = 90;
;
	lda     #$5A
	ldy     #$05
	sta     (sp),y
;
; x = 88;
;
	lda     #$58
	iny
	sta     (sp),y
;
; id = set_sprite(id, x,      y, SPR_DIGIT + 1, 3);         // 1
;
	jsr     decsp4
	ldy     #$0B
	lda     (sp),y
	ldy     #$03
	sta     (sp),y
	ldy     #$0A
	lda     (sp),y
	ldy     #$02
	sta     (sp),y
	ldy     #$09
	lda     (sp),y
	ldy     #$01
	sta     (sp),y
	lda     #$11
	dey
	sta     (sp),y
	lda     #$03
	jsr     _set_sprite
	ldy     #$07
	sta     (sp),y
;
; id = set_sprite(id, x + 8,  y, SPR_LETTER + 18, 3);       // S
;
	jsr     decsp4
	ldy     #$0B
	lda     (sp),y
	ldy     #$03
	sta     (sp),y
	ldy     #$0A
	lda     (sp),y
	clc
	adc     #$08
	ldy     #$02
	sta     (sp),y
	ldy     #$09
	lda     (sp),y
	ldy     #$01
	sta     (sp),y
	lda     #$42
	dey
	sta     (sp),y
	lda     #$03
	jsr     _set_sprite
	ldy     #$07
	sta     (sp),y
;
; id = set_sprite(id, x + 16, y, SPR_LETTER + 19, 3);       // T
;
	jsr     decsp4
	ldy     #$0B
	lda     (sp),y
	ldy     #$03
	sta     (sp),y
	ldy     #$0A
	lda     (sp),y
	clc
	adc     #$10
	ldy     #$02
	sta     (sp),y
	ldy     #$09
	lda     (sp),y
	ldy     #$01
	sta     (sp),y
	lda     #$43
	dey
	sta     (sp),y
	lda     #$03
	jsr     _set_sprite
	ldy     #$07
	sta     (sp),y
;
; x = 116;
;
	lda     #$74
	dey
	sta     (sp),y
;
; id = set_sprite(id, x,      y, SPR_LETTER + 15, 3);       // P
;
	jsr     decsp4
	ldy     #$0B
	lda     (sp),y
	ldy     #$03
	sta     (sp),y
	ldy     #$0A
	lda     (sp),y
	ldy     #$02
	sta     (sp),y
	ldy     #$09
	lda     (sp),y
	ldy     #$01
	sta     (sp),y
	lda     #$3F
	dey
	sta     (sp),y
	lda     #$03
	jsr     _set_sprite
	ldy     #$07
	sta     (sp),y
;
; id = set_sprite(id, x + 8,  y, SPR_LETTER + 11, 3);       // L
;
	jsr     decsp4
	ldy     #$0B
	lda     (sp),y
	ldy     #$03
	sta     (sp),y
	ldy     #$0A
	lda     (sp),y
	clc
	adc     #$08
	ldy     #$02
	sta     (sp),y
	ldy     #$09
	lda     (sp),y
	ldy     #$01
	sta     (sp),y
	lda     #$3B
	dey
	sta     (sp),y
	lda     #$03
	jsr     _set_sprite
	ldy     #$07
	sta     (sp),y
;
; id = set_sprite(id, x + 16, y, SPR_LETTER + 0,  3);       // A
;
	jsr     decsp4
	ldy     #$0B
	lda     (sp),y
	ldy     #$03
	sta     (sp),y
	ldy     #$0A
	lda     (sp),y
	clc
	adc     #$10
	ldy     #$02
	sta     (sp),y
	ldy     #$09
	lda     (sp),y
	ldy     #$01
	sta     (sp),y
	lda     #$30
	dey
	sta     (sp),y
	lda     #$03
	jsr     _set_sprite
	ldy     #$07
	sta     (sp),y
;
; id = set_sprite(id, x + 24, y, SPR_LETTER + 2,  3);       // C
;
	jsr     decsp4
	ldy     #$0B
	lda     (sp),y
	ldy     #$03
	sta     (sp),y
	ldy     #$0A
	lda     (sp),y
	clc
	adc     #$18
	ldy     #$02
	sta     (sp),y
	ldy     #$09
	lda     (sp),y
	ldy     #$01
	sta     (sp),y
	lda     #$32
	dey
	sta     (sp),y
	lda     #$03
	jsr     _set_sprite
	ldy     #$07
	sta     (sp),y
;
; id = set_sprite(id, x + 32, y, SPR_LETTER + 4,  3);       // E
;
	jsr     decsp4
	ldy     #$0B
	lda     (sp),y
	ldy     #$03
	sta     (sp),y
	ldy     #$0A
	lda     (sp),y
	clc
	adc     #$20
	ldy     #$02
	sta     (sp),y
	ldy     #$09
	lda     (sp),y
	ldy     #$01
	sta     (sp),y
	lda     #$34
	dey
	sta     (sp),y
	lda     #$03
	jsr     _set_sprite
	ldy     #$07
	sta     (sp),y
;
; y = 115;
;
	lda     #$73
	ldy     #$05
	sta     (sp),y
;
; x = 112;
;
	lda     #$70
	iny
	sta     (sp),y
;
; if (frame_count & 0x10) {
;
	lda     _frame_count
	and     #$10
	beq     L090C
;
; id = set_car(id, x, y, SPR_CAR, 0);
;
	jsr     decsp4
	ldy     #$0B
	lda     (sp),y
	ldy     #$03
	sta     (sp),y
	ldy     #$0A
	lda     (sp),y
	ldy     #$02
	sta     (sp),y
	ldy     #$09
	lda     (sp),y
	ldy     #$01
	sta     (sp),y
	lda     #$00
	dey
	sta     (sp),y
;
; } else {
;
	jmp     L0B47
;
; id = set_car(id, x, y, SPR_CAR, 0 | 0x40);  // H-flip
;
L090C:	jsr     decsp4
	ldy     #$0B
	lda     (sp),y
	ldy     #$03
	sta     (sp),y
	ldy     #$0A
	lda     (sp),y
	ldy     #$02
	sta     (sp),y
	ldy     #$09
	lda     (sp),y
	ldy     #$01
	sta     (sp),y
	lda     #$00
	dey
	sta     (sp),y
	lda     #$40
L0B47:	jsr     _set_car
	ldy     #$07
	sta     (sp),y
;
; y = 150;
;
	lda     #$96
	ldy     #$05
	sta     (sp),y
;
; x = 88;
;
	lda     #$58
	iny
	sta     (sp),y
;
; id = set_sprite(id, x,      y, SPR_LETTER + 18, 3);  // S
;
	jsr     decsp4
	ldy     #$0B
	lda     (sp),y
	ldy     #$03
	sta     (sp),y
	ldy     #$0A
	lda     (sp),y
	ldy     #$02
	sta     (sp),y
	ldy     #$09
	lda     (sp),y
	ldy     #$01
	sta     (sp),y
	lda     #$42
	dey
	sta     (sp),y
	lda     #$03
	jsr     _set_sprite
	ldy     #$07
	sta     (sp),y
;
; id = set_sprite(id, x + 8,  y, SPR_LETTER + 2,  3);  // C
;
	jsr     decsp4
	ldy     #$0B
	lda     (sp),y
	ldy     #$03
	sta     (sp),y
	ldy     #$0A
	lda     (sp),y
	clc
	adc     #$08
	ldy     #$02
	sta     (sp),y
	ldy     #$09
	lda     (sp),y
	ldy     #$01
	sta     (sp),y
	lda     #$32
	dey
	sta     (sp),y
	lda     #$03
	jsr     _set_sprite
	ldy     #$07
	sta     (sp),y
;
; id = set_sprite(id, x + 16, y, SPR_LETTER + 14, 3);  // O
;
	jsr     decsp4
	ldy     #$0B
	lda     (sp),y
	ldy     #$03
	sta     (sp),y
	ldy     #$0A
	lda     (sp),y
	clc
	adc     #$10
	ldy     #$02
	sta     (sp),y
	ldy     #$09
	lda     (sp),y
	ldy     #$01
	sta     (sp),y
	lda     #$3E
	dey
	sta     (sp),y
	lda     #$03
	jsr     _set_sprite
	ldy     #$07
	sta     (sp),y
;
; id = set_sprite(id, x + 24, y, SPR_LETTER + 17, 3);  // R
;
	jsr     decsp4
	ldy     #$0B
	lda     (sp),y
	ldy     #$03
	sta     (sp),y
	ldy     #$0A
	lda     (sp),y
	clc
	adc     #$18
	ldy     #$02
	sta     (sp),y
	ldy     #$09
	lda     (sp),y
	ldy     #$01
	sta     (sp),y
	lda     #$41
	dey
	sta     (sp),y
	lda     #$03
	jsr     _set_sprite
	ldy     #$07
	sta     (sp),y
;
; id = set_sprite(id, x + 32, y, SPR_LETTER + 4,  3);  // E
;
	jsr     decsp4
	ldy     #$0B
	lda     (sp),y
	ldy     #$03
	sta     (sp),y
	ldy     #$0A
	lda     (sp),y
	clc
	adc     #$20
	ldy     #$02
	sta     (sp),y
	ldy     #$09
	lda     (sp),y
	ldy     #$01
	sta     (sp),y
	lda     #$34
	dey
	sta     (sp),y
	lda     #$03
	jsr     _set_sprite
	ldy     #$07
	sta     (sp),y
;
; y = 165;
;
	lda     #$A5
	ldy     #$05
	sta     (sp),y
;
; x = 96;
;
	lda     #$60
	iny
	sta     (sp),y
;
; s = score;
;
	lda     _score
	ldx     _score+1
	ldy     #$03
	jsr     staxysp
;
; if (s > 999) s = 999;  // Cap display
;
	cmp     #$E8
	txa
	sbc     #$03
	bcc     L094E
	ldy     #$03
	lda     #$E7
	sta     (sp),y
	tya
	iny
	sta     (sp),y
;
; id = set_sprite(id, x,      y, SPR_DIGIT + (unsigned char)(s / 100), 3);
;
L094E:	jsr     decsp4
	ldy     #$0B
	lda     (sp),y
	ldy     #$03
	sta     (sp),y
	ldy     #$0A
	lda     (sp),y
	ldy     #$02
	sta     (sp),y
	ldy     #$09
	lda     (sp),y
	ldy     #$01
	sta     (sp),y
	ldy     #$0A
	jsr     pushwysp
	lda     #$64
	jsr     tosudiva0
	clc
	adc     #$10
	ldy     #$00
	sta     (sp),y
	lda     #$03
	jsr     _set_sprite
	ldy     #$07
	sta     (sp),y
;
; id = set_sprite(id, x + 8,  y, SPR_DIGIT + (unsigned char)((s / 10) % 10), 3);
;
	jsr     decsp4
	ldy     #$0B
	lda     (sp),y
	ldy     #$03
	sta     (sp),y
	ldy     #$0A
	lda     (sp),y
	clc
	adc     #$08
	ldy     #$02
	sta     (sp),y
	ldy     #$09
	lda     (sp),y
	ldy     #$01
	sta     (sp),y
	ldy     #$0A
	jsr     pushwysp
	lda     #$0A
	jsr     tosudiva0
	jsr     pushax
	lda     #$0A
	jsr     tosumoda0
	clc
	adc     #$10
	ldy     #$00
	sta     (sp),y
	lda     #$03
	jsr     _set_sprite
	ldy     #$07
	sta     (sp),y
;
; id = set_sprite(id, x + 16, y, SPR_DIGIT + (unsigned char)(s % 10), 3);
;
	jsr     decsp4
	ldy     #$0B
	lda     (sp),y
	ldy     #$03
	sta     (sp),y
	ldy     #$0A
	lda     (sp),y
	clc
	adc     #$10
	ldy     #$02
	sta     (sp),y
	ldy     #$09
	lda     (sp),y
	ldy     #$01
	sta     (sp),y
	ldy     #$0A
	jsr     pushwysp
	lda     #$0A
	jsr     tosumoda0
	clc
	adc     #$10
	ldy     #$00
	sta     (sp),y
	lda     #$03
	jsr     _set_sprite
	ldy     #$07
	sta     (sp),y
;
; id = set_sprite(id, x + 24, y, SPR_LETTER + 15, 3);  // P
;
	jsr     decsp4
	ldy     #$0B
	lda     (sp),y
	ldy     #$03
	sta     (sp),y
	ldy     #$0A
	lda     (sp),y
	clc
	adc     #$18
	ldy     #$02
	sta     (sp),y
	ldy     #$09
	lda     (sp),y
	ldy     #$01
	sta     (sp),y
	lda     #$3F
	dey
	sta     (sp),y
	lda     #$03
	jsr     _set_sprite
	ldy     #$07
	sta     (sp),y
;
; id = set_sprite(id, x + 32, y, SPR_LETTER + 19, 3);  // T (PTS)
;
	jsr     decsp4
	ldy     #$0B
	lda     (sp),y
	ldy     #$03
	sta     (sp),y
	ldy     #$0A
	lda     (sp),y
	clc
	adc     #$20
	ldy     #$02
	sta     (sp),y
	ldy     #$09
	lda     (sp),y
	ldy     #$01
	sta     (sp),y
	lda     #$43
	dey
	sta     (sp),y
	lda     #$03
	jsr     _set_sprite
	ldy     #$07
	sta     (sp),y
;
; id = set_sprite(id, x + 40, y, SPR_LETTER + 18, 3);  // S
;
	jsr     decsp4
	ldy     #$0B
	lda     (sp),y
	ldy     #$03
	sta     (sp),y
	ldy     #$0A
	lda     (sp),y
	clc
	adc     #$28
	ldy     #$02
	sta     (sp),y
	ldy     #$09
	lda     (sp),y
	ldy     #$01
	sta     (sp),y
	lda     #$42
	dey
	sta     (sp),y
	lda     #$03
	jsr     _set_sprite
	ldy     #$07
	sta     (sp),y
;
; if (win_timer > 90 && (frame_count & 0x20)) {
;
	lda     _win_timer
	cmp     #$5B
	jcc     L0B45
	lda     _frame_count
	and     #$20
	jeq     L0B45
;
; y = 200;
;
	lda     #$C8
	ldy     #$05
	sta     (sp),y
;
; x = 72;
;
	lda     #$48
	iny
	sta     (sp),y
;
; id = set_sprite(id, x,      y, SPR_LETTER + 15, 3);  // P
;
	jsr     decsp4
	ldy     #$0B
	lda     (sp),y
	ldy     #$03
	sta     (sp),y
	ldy     #$0A
	lda     (sp),y
	ldy     #$02
	sta     (sp),y
	ldy     #$09
	lda     (sp),y
	ldy     #$01
	sta     (sp),y
	lda     #$3F
	dey
	sta     (sp),y
	lda     #$03
	jsr     _set_sprite
	ldy     #$07
	sta     (sp),y
;
; id = set_sprite(id, x + 8,  y, SPR_LETTER + 17, 3);  // R
;
	jsr     decsp4
	ldy     #$0B
	lda     (sp),y
	ldy     #$03
	sta     (sp),y
	ldy     #$0A
	lda     (sp),y
	clc
	adc     #$08
	ldy     #$02
	sta     (sp),y
	ldy     #$09
	lda     (sp),y
	ldy     #$01
	sta     (sp),y
	lda     #$41
	dey
	sta     (sp),y
	lda     #$03
	jsr     _set_sprite
	ldy     #$07
	sta     (sp),y
;
; id = set_sprite(id, x + 16, y, SPR_LETTER + 4,  3);  // E
;
	jsr     decsp4
	ldy     #$0B
	lda     (sp),y
	ldy     #$03
	sta     (sp),y
	ldy     #$0A
	lda     (sp),y
	clc
	adc     #$10
	ldy     #$02
	sta     (sp),y
	ldy     #$09
	lda     (sp),y
	ldy     #$01
	sta     (sp),y
	lda     #$34
	dey
	sta     (sp),y
	lda     #$03
	jsr     _set_sprite
	ldy     #$07
	sta     (sp),y
;
; id = set_sprite(id, x + 24, y, SPR_LETTER + 18, 3);  // S
;
	jsr     decsp4
	ldy     #$0B
	lda     (sp),y
	ldy     #$03
	sta     (sp),y
	ldy     #$0A
	lda     (sp),y
	clc
	adc     #$18
	ldy     #$02
	sta     (sp),y
	ldy     #$09
	lda     (sp),y
	ldy     #$01
	sta     (sp),y
	lda     #$42
	dey
	sta     (sp),y
	lda     #$03
	jsr     _set_sprite
	ldy     #$07
	sta     (sp),y
;
; id = set_sprite(id, x + 32, y, SPR_LETTER + 18, 3);  // S
;
	jsr     decsp4
	ldy     #$0B
	lda     (sp),y
	ldy     #$03
	sta     (sp),y
	ldy     #$0A
	lda     (sp),y
	clc
	adc     #$20
	ldy     #$02
	sta     (sp),y
	ldy     #$09
	lda     (sp),y
	ldy     #$01
	sta     (sp),y
	lda     #$42
	dey
	sta     (sp),y
	lda     #$03
	jsr     _set_sprite
	ldy     #$07
	sta     (sp),y
;
; x = 128;
;
	lda     #$80
	dey
	sta     (sp),y
;
; id = set_sprite(id, x,      y, SPR_LETTER + 18, 3);  // S
;
	jsr     decsp4
	ldy     #$0B
	lda     (sp),y
	ldy     #$03
	sta     (sp),y
	ldy     #$0A
	lda     (sp),y
	ldy     #$02
	sta     (sp),y
	ldy     #$09
	lda     (sp),y
	ldy     #$01
	sta     (sp),y
	lda     #$42
	dey
	sta     (sp),y
	lda     #$03
	jsr     _set_sprite
	ldy     #$07
	sta     (sp),y
;
; id = set_sprite(id, x + 8,  y, SPR_LETTER + 19, 3);  // T
;
	jsr     decsp4
	ldy     #$0B
	lda     (sp),y
	ldy     #$03
	sta     (sp),y
	ldy     #$0A
	lda     (sp),y
	clc
	adc     #$08
	ldy     #$02
	sta     (sp),y
	ldy     #$09
	lda     (sp),y
	ldy     #$01
	sta     (sp),y
	lda     #$43
	dey
	sta     (sp),y
	lda     #$03
	jsr     _set_sprite
	ldy     #$07
	sta     (sp),y
;
; id = set_sprite(id, x + 16, y, SPR_LETTER + 0,  3);  // A
;
	jsr     decsp4
	ldy     #$0B
	lda     (sp),y
	ldy     #$03
	sta     (sp),y
	ldy     #$0A
	lda     (sp),y
	clc
	adc     #$10
	ldy     #$02
	sta     (sp),y
	ldy     #$09
	lda     (sp),y
	ldy     #$01
	sta     (sp),y
	lda     #$30
	dey
	sta     (sp),y
	lda     #$03
	jsr     _set_sprite
	ldy     #$07
	sta     (sp),y
;
; id = set_sprite(id, x + 24, y, SPR_LETTER + 17, 3);  // R
;
	jsr     decsp4
	ldy     #$0B
	lda     (sp),y
	ldy     #$03
	sta     (sp),y
	ldy     #$0A
	lda     (sp),y
	clc
	adc     #$18
	ldy     #$02
	sta     (sp),y
	ldy     #$09
	lda     (sp),y
	ldy     #$01
	sta     (sp),y
	lda     #$41
	dey
	sta     (sp),y
	lda     #$03
	jsr     _set_sprite
	ldy     #$07
	sta     (sp),y
;
; id = set_sprite(id, x + 32, y, SPR_LETTER + 19, 3);  // T
;
	jsr     decsp4
	ldy     #$0B
	lda     (sp),y
	ldy     #$03
	sta     (sp),y
	ldy     #$0A
	lda     (sp),y
	clc
	adc     #$20
	ldy     #$02
	sta     (sp),y
	ldy     #$09
	lda     (sp),y
	ldy     #$01
	sta     (sp),y
	lda     #$43
	dey
	sta     (sp),y
	lda     #$03
	jsr     _set_sprite
	ldy     #$07
;
; while (id < 64) {
;
	jmp     L0B48
;
; OAM[id * 4] = 0xFF;
;
L0B44:	lda     (sp),y
	jsr     shlax2
	inx
	inx
	sta     ptr1
	stx     ptr1+1
	lda     #$FF
	ldy     #$00
	sta     (ptr1),y
;
; ++id;
;
	ldy     #$07
	clc
	lda     #$01
	adc     (sp),y
L0B48:	sta     (sp),y
;
; while (id < 64) {
;
L0B45:	ldx     #$00
	lda     (sp),y
	cmp     #$40
	bcc     L0B44
;
; }
;
	jmp     incsp8

.endproc

; ---------------------------------------------------------------
; void __near__ draw_pause (void)
; ---------------------------------------------------------------

.segment	"CODE"

.proc	_draw_pause: near

.segment	"CODE"

;
; unsigned char id = 0;
;
	lda     #$00
	jsr     pusha
;
; unsigned char x = 92, y = 100;
;
	lda     #$5C
	jsr     pusha
	lda     #$64
	jsr     pusha
;
; draw_game();
;
	jsr     _draw_game
;
; if (frame_count & 0x10) {
;
	lda     _frame_count
	and     #$10
	bne     L0B49
;
; }
;
	jmp     incsp3
;
; id = set_sprite(id, x,      y, SPR_LETTER + 15, 3);  // P
;
L0B49:	jsr     decsp4
	ldy     #$06
	lda     (sp),y
	ldy     #$03
	sta     (sp),y
	ldy     #$05
	lda     (sp),y
	ldy     #$02
	sta     (sp),y
	ldy     #$04
	lda     (sp),y
	ldy     #$01
	sta     (sp),y
	lda     #$3F
	dey
	sta     (sp),y
	lda     #$03
	jsr     _set_sprite
	ldy     #$02
	sta     (sp),y
;
; id = set_sprite(id, x + 8,  y, SPR_LETTER + 0,  3);  // A
;
	jsr     decsp4
	ldy     #$06
	lda     (sp),y
	ldy     #$03
	sta     (sp),y
	ldy     #$05
	lda     (sp),y
	clc
	adc     #$08
	ldy     #$02
	sta     (sp),y
	ldy     #$04
	lda     (sp),y
	ldy     #$01
	sta     (sp),y
	lda     #$30
	dey
	sta     (sp),y
	lda     #$03
	jsr     _set_sprite
	ldy     #$02
	sta     (sp),y
;
; id = set_sprite(id, x + 16, y, SPR_LETTER + 20, 3);  // U
;
	jsr     decsp4
	ldy     #$06
	lda     (sp),y
	ldy     #$03
	sta     (sp),y
	ldy     #$05
	lda     (sp),y
	clc
	adc     #$10
	ldy     #$02
	sta     (sp),y
	ldy     #$04
	lda     (sp),y
	ldy     #$01
	sta     (sp),y
	lda     #$44
	dey
	sta     (sp),y
	lda     #$03
	jsr     _set_sprite
	ldy     #$02
	sta     (sp),y
;
; id = set_sprite(id, x + 24, y, SPR_LETTER + 18, 3);  // S
;
	jsr     decsp4
	ldy     #$06
	lda     (sp),y
	ldy     #$03
	sta     (sp),y
	ldy     #$05
	lda     (sp),y
	clc
	adc     #$18
	ldy     #$02
	sta     (sp),y
	ldy     #$04
	lda     (sp),y
	ldy     #$01
	sta     (sp),y
	lda     #$42
	dey
	sta     (sp),y
	lda     #$03
	jsr     _set_sprite
	ldy     #$02
	sta     (sp),y
;
; id = set_sprite(id, x + 32, y, SPR_LETTER + 4,  3);  // E
;
	jsr     decsp4
	ldy     #$06
	lda     (sp),y
	ldy     #$03
	sta     (sp),y
	ldy     #$05
	lda     (sp),y
	clc
	adc     #$20
	ldy     #$02
	sta     (sp),y
	ldy     #$04
	lda     (sp),y
	ldy     #$01
	sta     (sp),y
	lda     #$34
	dey
	sta     (sp),y
	lda     #$03
	jsr     _set_sprite
	ldy     #$02
	sta     (sp),y
;
; }
;
	jmp     incsp3

.endproc

; ---------------------------------------------------------------
; void __near__ main (void)
; ---------------------------------------------------------------

.segment	"CODE"

.proc	_main: near

.segment	"CODE"

;
; rnd_seed = 42;
;
	lda     #$2A
	sta     _rnd_seed
;
; game_state = STATE_TITLE;
;
	lda     #$00
	sta     _game_state
;
; wait_vblank();
;
	jsr     _wait_vblank
;
; wait_vblank();
;
	jsr     _wait_vblank
;
; ppu_off();
;
	jsr     _ppu_off
;
; init_apu();
;
	jsr     _init_apu
;
; music_play(0);  // Title BGM
;
	lda     #$00
	jsr     _music_play
;
; load_palettes();
;
	jsr     _load_palettes
;
; draw_road();
;
	jsr     _draw_road
;
; PPU_CTRL = 0x88;  // NMI on, sprites at $1000
;
	lda     #$88
	sta     $2000
;
; ppu_on();
;
	jsr     _ppu_on
;
; wait_vblank();
;
L0A29:	jsr     _wait_vblank
;
; OAM_ADDR = 0;
;
	lda     #$00
	sta     $2003
;
; OAM_DMA = 0x02;
;
	lda     #$02
	sta     $4014
;
; PPU_SCROLL = 0;
;
	lda     #$00
	sta     $2005
;
; PPU_SCROLL = scroll_y;
;
	lda     _scroll_y
	sta     $2005
;
; pad_old = pad_now;
;
	lda     _pad_now
	sta     _pad_old
;
; pad_now = read_pad();
;
	jsr     _read_pad
	sta     _pad_now
;
; pad_new = pad_now & ~pad_old;
;
	lda     _pad_old
	eor     #$FF
	and     _pad_now
	sta     _pad_new
;
; ++frame_count;
;
	inc     _frame_count
;
; rnd_seed ^= frame_count;
;
	lda     _frame_count
	eor     _rnd_seed
	sta     _rnd_seed
;
; clear_sprites();
;
	jsr     _clear_sprites
;
; music_update();
;
	jsr     _music_update
;
; switch (game_state) {
;
	lda     _game_state
;
; }
;
	beq     L0A49
	cmp     #$01
	beq     L0B4A
	cmp     #$02
	beq     L0B4B
	cmp     #$03
	beq     L0A6D
	cmp     #$04
	jeq     L0A76
	cmp     #$05
	beq     L0A5C
	jmp     L0A29
;
; draw_title();
;
L0A49:	jsr     _draw_title
;
; if (pad_new & BTN_START) {
;
	lda     _pad_new
	and     #$10
	beq     L0A29
;
; init_game();
;
	jsr     _init_game
;
; music_play(1);  // Racing BGM - energetic!
;
	lda     #$01
	jsr     _music_play
;
; game_state = STATE_RACING;
;
	lda     #$01
	sta     _game_state
;
; break;
;
	jmp     L0A29
;
; if (pad_new & BTN_START) {
;
L0B4A:	lda     _pad_new
	and     #$10
	beq     L0A54
;
; game_state = STATE_PAUSED;
;
	lda     #$05
	sta     _game_state
;
; } else {
;
	jmp     L0A29
;
; update_game();
;
L0A54:	jsr     _update_game
;
; draw_game();
;
	jsr     _draw_game
;
; break;
;
	jmp     L0A29
;
; draw_pause();
;
L0A5C:	jsr     _draw_pause
;
; if (pad_new & BTN_START) {
;
	lda     _pad_new
	and     #$10
	jeq     L0A29
;
; game_state = STATE_RACING;
;
	lda     #$01
	sta     _game_state
;
; break;
;
	jmp     L0A29
;
; ++pit_timer;
;
L0B4B:	inc     _pit_timer
;
; if (pit_timer >= 60) {
;
	lda     _pit_timer
	cmp     #$3C
	bcc     L0A65
;
; player_hp = PLAYER_MAX_HP;
;
	lda     #$05
	sta     _player_hp
;
; game_state = STATE_RACING;
;
	lda     #$01
	sta     _game_state
;
; draw_game();
;
L0A65:	jsr     _draw_game
;
; break;
;
	jmp     L0A29
;
; draw_gameover();
;
L0A6D:	jsr     _draw_gameover
;
; if (pad_new & BTN_START) {
;
	lda     _pad_new
	and     #$10
	jeq     L0A29
;
; music_play(0);  // Back to title BGM
;
	lda     #$00
	jsr     _music_play
;
; game_state = STATE_TITLE;
;
	lda     #$00
	sta     _game_state
;
; break;
;
	jmp     L0A29
;
; update_win_animation();
;
L0A76:	jsr     _update_win_animation
;
; draw_win();
;
	jsr     _draw_win
;
; if (win_timer > 90 && (pad_new & BTN_START)) {
;
	lda     _win_timer
	cmp     #$5B
	jcc     L0A29
	lda     _pad_new
	and     #$10
	jeq     L0A29
;
; music_play(0);  // Back to title BGM
;
	lda     #$00
	jsr     _music_play
;
; game_state = STATE_TITLE;
;
	lda     #$00
	sta     _game_state
;
; break;
;
	jmp     L0A29

.endproc

